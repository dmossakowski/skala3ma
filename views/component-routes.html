        <style>
            /* Style for the modal dialog container */
            .modal-container {
                display: none;
                position: fixed;
                z-index: 1023;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgba(0, 0, 0, 0.4);
            }
    
            /* Style for the modal dialog box */
            .modal-box {
                background-color: #fff;
                margin: 2% auto;
                padding: 0px 0px 15px 0px;
                border: 1px solid #888;
                width:370px;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%); 
                display: block;
                
                justify-content: center;
                align-items: center;
                text-align: center;
                font-size: 14px;
                color: #333;
            }
    
            /* Style for the close button */
            .close-button {
                position: relative;
                padding: 0px 15px 0px 0px;
                justify-content: right;
                text-align: right;
                
                color: #aaa;
                font-weight: bold;
                
            }

            .form-row-heading {
                          display: flex;
                          justify-content: center;
                          align-items: baseline;
                          margin: 1px;
                          font-size: 20px;
                          color: #292424;
                          font-weight: bold;
                          vertical-align: bottom;
                          
                        }
                        .form-row {
                          display: flex;
                          
                          align-items: center;
                          font-size: 18px;
                          margin: 10px 6px 10px 6px;
                          /*word-wrap: break-word;*/
                          
                        }
                      
                        .form-row label {

                          justify-content: left;
                          text-align: left;
                          display: block;
                          margin-right: 6px;
                          
                        }
                      
                        .form-row input,
                        .form-row select,
                        .form-row textarea {
                          flex: 1;
                        }



                        .custom-select-wrapper {
    position: relative;
    display: inline-block;
    width: 80%;
}

.custom-select {
    display: inline-block;
    width: 100%;
    padding: 6px;
    font-size: 1.6em;
    font-weight: bold;
    color: #40ad48;
    background-color: #eff3ef;
    border: none;
    border-radius: 2%;
    appearance: none; /* Remove default dropdown arrow */
    -webkit-appearance: none; /* Remove default dropdown arrow in Safari */
    -moz-appearance: none; /* Remove default dropdown arrow in Firefox */
    box-shadow: 1px 1px 1px 3px #9ecab3;
    outline: none;
}

.custom-select-wrapper::after {
    content: '\25BC'; /* Unicode character for down arrow */
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    pointer-events: none;
    font-size: 1.6em;
    color: #40ad48; /* Match the color of the select text */
}

        </style>
    


        

        <div id="modal" class="modal-container">

            <div id="modal-box" class="modal-box ">
                <div class="row close-button row">
                    <span  onclick="hideModal()">
                    <i class="bi bi-x" style="font-size: 2rem; color: rgb(98, 92, 92);"></i>
                    </span>
                    
                </div> 
            
                
                <div class="form-row row">
                    <div id="hidden_message" class="form-row-heading" style=" font: bold 24px;color: red; align-content: center;">
                    </div>
                </div>
               
                <div id="mainModalMenu">
                    <div onclick="hideModal()">
                    <div id="routeDetails" class="form-row-heading">
                      <div id="route-routenum" style="font-size:40px;"></div>  &nbsp;&nbsp;&nbsp; 
                      <div id="route-name"> ROUTE NAME   </div>
                      &nbsp;&nbsp;&nbsp;
                      <div id="route-stars-view" aria-label="Route stars" style="display:inline-flex; gap:2px; vertical-align:middle;"></div>
                    </div>

                <div class="form-row-heading">
                    <div id="route-line" style="font-size:20px;"></div> &nbsp;&nbsp;&nbsp;
                    <div id="route-color1">&nbsp;&nbsp;&nbsp;</div>&nbsp;&nbsp;  <div id="route-grade"></div>
                </div>
                <div class="form-row-heading">
                    <div id="route-openedby">&nbsp;&nbsp;&nbsp;</div>&nbsp;&nbsp;  <div id="route-opendate"></div>
                </div>
                <div class="form-row-heading">
                    <div id="route-notes">&nbsp;&nbsp;&nbsp;</div>
                </div>
                </div>
                <div class="form-row-heading">
                  <!--button id='submitbutton' type="button" class="btn btn-info btn-lg" onclick="addActivityRoute()">I finished it</button-->
                  <div id="edit-controls" style="display:none;">
                    <button id='editbutton' type="button" class="btn btn-success btn-md" onclick="editContent();">
                      <i class="bi bi-three-dots-vertical"></i><span data-translate-key="edit"></span></button>&nbsp;
                    <button id='closebutton' type="button" class="btn btn-success btn-md" onclick="addBefore()"><span data-translate-key="add_new_route"></span></button>&nbsp;
                  </div>
                </div>      
            </div>
            
<!-- start user rating -->
                    
<div id='route-rating-div' style="display:none; padding:8px; margin-top:8px; border-top:1px solid #ddd;">
  <h4 style="margin:8px 0 8px 0; font-size:1rem;">&nbsp;<span data-translate-key="rate">&nbsp;</span></h4>
    <div class="form-row row">
        <div id="route-status-picker" class="btn-group w-100" role="group" aria-label="Route finish status" style="display:flex; gap:8px; justify-content:space-between;">
          <input type="hidden" id="routeFinishStatus" name="route_finish_status" value="climbed">
          <button type="button" class="btn btn-light status-btn" data-status="attempted" onclick="setRouteFinishStatus('attempted')">
            <img src="/public/images/4125784_confounded_confused_emoji_emotion_fail_icon.png" alt="attempted" width="40" height="40">
          </button>
          <button type="button" class="btn btn-light status-btn" data-status="climbed" onclick="setRouteFinishStatus('climbed')">
            <img src="/public/images/1398911_correct_mark_success_tick_valid_icon.png" alt="climbed" width="40" height="40">
          </button>
          <button type="button" class="btn btn-light status-btn" data-status="flashed" onclick="setRouteFinishStatus('flashed')">
            <img src="/public/images/2682840_bolt_elictricity_light_lightning_storm_icon.png" alt="flashed" width="40" height="40">
          </button>
        </div>
        <script>
          // Keep global routeFinishStatus for existing code paths
          function setRouteFinishStatus(status){
            try { window.routeFinishStatus = status; } catch(e) {}
            var hidden = document.getElementById('routeFinishStatus');
            if (hidden) hidden.value = status;
            var picker = document.getElementById('route-status-picker');
            if (!picker) return;
            // toggle active style
            picker.querySelectorAll('button').forEach(btn => {
              const isActive = btn.getAttribute('data-status') === status;
              btn.classList.toggle('active', isActive);
              if (isActive) {
                // green border and pressed effect
                btn.classList.add('border','border-success');
                btn.style.boxShadow = 'inset 0 2px 6px rgba(0,0,0,0.15), 0 0 0 2px rgba(64,173,72,0.2)';
                btn.style.transform = 'translateY(1px)';
              } else {
                btn.classList.remove('border','border-success');
                btn.style.boxShadow = '';
                btn.style.transform = '';
              }
            });
          }
          // Initialize default selection similar to resetFlashImage()
          (function(){ setRouteFinishStatus('climbed'); })();
        </script>
        </div>
        <div class="row" style="margin-top:8px;">
          <div>
            <select class="form-select" id='grade_user' name="grade_user" size="1" type="text" style="font-size:1rem; font-weight:600; color:#40ad48;">
                <option value="?">?</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4a">4a</option>
                <option value="4b">4b</option>
                <option value="4c">4c</option>
                <option value="5a">5a</option>
                <option value="5a+">5a+</option>
                <option value="5b">5b</option>
                <option value="5b+">5b+</option>
                <option value="5c">5c</option>
                <option value="5c+">5c+</option>
                <option value="6a">6a</option>
                <option value="6a+">6a+</option>
                <option value="6b">6b</option>
                <option value="6b+">6b+</option>
                <option value="6c">6c</option>
                <option value="6c+">6c+</option>
                <option value="7a">7a</option>
                <option value="7a+">7a+</option>
                <option value="7b">7b</option>
                <option value="7b+">7b+</option>
                <option value="7c">7c</option>
                <option value="7c+">7c+</option>
                <option value="8a">8a</option>
                <option value="8a+">8a+</option>
                <option value="8b">8b</option>
                <option value="8b+">8b+</option>
                <option value="8c">8c</option>
                <option value="8c+">8c+</option>
                <option value="9a">9a</option>
                <option value="9a+">9a+</option>
                <option value="9b">9b</option>
                <option value="9b+">9b+</option>
                <option value="9c">9c</option>
            
                </select>

          </div>
        </div>
        <div class="row" style="margin-top:8px;">
            <div class="rating" id="route-stars" style="display:flex; flex-direction:row-reverse; justify-content:center;">
                <input type="radio" name="route_stars" value="3" id="stars3" style="display:none">
                <label for="stars3" style="position:relative; width:1em; font-size:30px; font-weight:300; color:#FFD600; cursor:pointer">☆</label>
                <input type="radio" name="route_stars" value="2" id="stars2" style="display:none">
                <label for="stars2" style="position:relative; width:1em; font-size:30px; font-weight:300; color:#FFD600; cursor:pointer">☆</label>
                <input type="radio" name="route_stars" value="1" id="stars1" style="display:none">
                <label for="stars1" style="position:relative; width:1em; font-size:30px; font-weight:300; color:#FFD600; cursor:pointer">☆</label>
            </div>
            <style>
                /* Inline star rating styles (temporary; to be moved to CSS later) */
                #route-stars > label::before { content:"\2605"; position:absolute; opacity:0; }
                #route-stars > label:hover:before,
                #route-stars > label:hover ~ label:before { opacity:1 !important; }
                #route-stars > input:checked ~ label:before { opacity:1; }
                #route-stars:hover > input:checked ~ label:before { opacity:0.4; }
              /* Pressed+green style for status buttons when active */
              .status-btn.active { border-color: #40ad48 !important; }
            </style>
        </div>

        <div style="display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap; margin-top:8px;">
          <button id='editbutton' type="button" class="btn btn-success flex-grow-1" onclick="rateRoute();">
            <i class="bi bi-plus-circle" style="color: white;"></i> <span data-translate-key="add"></span>
          </button>
          <button type="button" class="btn btn-secondary flex-grow-1" onclick="hideModal()" data-translate-key="cancel"></button>
          <button type="button" class="btn btn-danger flex-grow-1" style="display:none;" data-translate-key="Delete"></button>
        </div>
    </div>               



<!-- end user rating-->



                    <div id="editContent" style="display: none">

                         <div class="form-row">
                          <input type="hidden" id="routeid" name="routeid" value="">
                          
                        </div>
                      
                        <div class="form-row">
                          <!--label for="routenum"><script>document.write(getTranslation('route_num'))</script>:</label-->
                          <input type="hidden" id="routenum" name="routenum" value="1">
                        </div>
                      
                        <div class="form-row">
                          <label for="line" data-translate-key="line"></label>
                          <input type="text" id="line" name="line" value="1">
                        </div>
                      
                        <div class="form-row">
                          <input type="hidden" id="colorfr" name="colorfr" value="#2e8b57">
                        </div>
                      
                        <div class="form-row">
                            <div class="col col-sm-2">
                          <label for="color1" data-translate-key="color1"></label>
                           </div>
                           <div class="col col-lg-3">
                          <input id="color1"  type="color"  
                          style="background-color: transparent; border:0; outline: none; padding:0px; height: 35px; width: 90%;"  >
                          </div>
                             <div id="color2label" class="col col-sm-2">
                               <label for="color2" data-translate-key="color2"></label>
                             </div>
                             <div id="color2input" class="col col-lg-3">
                               <input id="color2" type="color"
                                      style="background-color: transparent; border:0; outline: none; padding:0px; height: 35px; width: 90%; " >
                            
                           </div>


                              </input>
                          <!--div id="color1-display" style="background-color: #819a1e; width: 20px; height: 20px;"></div-->
                        </div>
                      
                        <div class="form-row">
                          <label for="color_modifier" data-translate-key="color_modifier"></label>
                          
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="color_modifier" id="color_modifier_solid" value="solid">
                            <label class="form-check-label" for="color_modifier_solid" data-translate-key="solid"></label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="color_modifier" id="color_modifier_marble" value="marble">
                            <label class="form-check-label" for="color_modifier_marble" data-translate-key="marble"></label>
                          </div>
                          


                          <!--select id="color_modifiermm" name="color_modifiermm">
                            <option value="solid" data-translate-key="solid"></option>
                            <option value="marble" data-translate-key="marble"></option> 
                          </select-->
                        </div>
                      
                        <div class="form-row">
                          <label for="grade" data-translate-key="grade"></label>
                          <select id="grade" name="grade">
                            <option value="?">?</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4a">4a</option>
                            <option value="4b">4b</option>
                            <option value="4c">4c</option>
                            <option value="5a">5a</option>
                            <option value="5a+">5a+</option>
                            <option value="5b">5b</option>
                            <option value="5b+">5b+</option>
                            <option value="5c">5c</option>
                            <option value="5c+">5c+</option>
                            <option value="6a">6a</option>
                            <option value="6a+">6a+</option>
                            <option value="6b">6b</option>
                            <option value="6b+">6b+</option>
                            <option value="6c">6c</option>
                            <option value="6c+">6c+</option>
                            <option value="7a">7a</option>
                            <option value="7a+">7a+</option>
                            <option value="7b">7b</option>
                            <option value="7b+">7b+</option>
                            <option value="7c">7c</option>
                            <option value="7c+">7c+</option>
                            <option value="8a">8a</option>
                            <option value="8a+">8a+</option>
                            <option value="8b">8b</option>
                            <option value="8b+">8b+</option>
                            <option value="8c">8c</option>
                            <option value="8c+">8c+</option>
                            <option value="9a">9a</option>
                            <option value="9a+">9a+</option>
                            <option value="9b">9b</option>
                            <option value="9b+">9b+</option>
                            <option value="9c">9c</option>
                          </select>
                          
                        </div>
                      
                        <div class="form-row">
                          <label for="name" data-translate-key="route_name"></label>
                          <input type="text" id="name" name="name" value="">
                        </div>
                      
                        <div class="form-row">
                          <label for="openedby" data-translate-key="route_opened_by"></label>
                          <input type="text" id="openedby" name="openedby" value="">
                        </div>
                      
                        <div class="form-row">
                          <label for="opendate" data-translate-key="route_opened_date"></label>
                          <input type="date" id="opendate" name="opendate" value="">
                        </div>
                      
                        <div class="form-row">
                          <label for="notes" data-translate-key="notes"></label>
                          <textarea id="notes" name="notes">très facile</textarea>  <!-- TODO revoir le texte ici ?-->
                        </div>
                      

                  <div class="form-row-heading row">
                    
                    
                    <button id='submitbutton' type="button" class="btn btn-success btn-lg" onclick="saveLine()"><span data-translate-key="save"></span></button>&nbsp;
                  
                  <!--button id='cancelbutton' type="button" class="btn btn-info" onclick="hideModal()"><script>document.write(getTranslation('cancel'))</script></button-->
                    </div>    
                    <!--div class="form-row-heading">
                  <button id='closebutton' type="button" class="btn btn-info" onclick="addBefore()"><span data-translate-key="add_before"></span></button>&nbsp;
                  <button id='submitbutton' type="button" class="btn btn-info" onclick="addAfter()"><span data-translate-key="add_after"></span></button>
                    </div-->    <div class="form-row row"></div>
                     <button id='deletebutton' type="button" class="btn btn-danger btn-sm" onclick="deleteContent()">{{reference_data['current_language'].remove}} {{reference_data['current_language'].route}}</button>
                 </div>
                </div>
                
            </div>
            
        </div>


        <script>


            // Get the modal dialog container
            var modal = document.getElementById("modal");
            var editDiv = document.getElementById('editContent');
            var mainModalMenuDiv = document.getElementById('mainModalMenu');
            var modalBoxDiv = document.getElementById('modal-box');
            var routeRatingDiv = document.getElementById('route-rating-div');
            var currentRow;
            var mod_type;
            var isLoggedIn = false;



            function showEditDiv(){
                mainModalMenuDiv.style.display='none'
                editDiv.style.display='block';
            }

            function editContent(){
                mod_type='save'
                showEditDiv();
                hideRatigngUi();
                return false;
            }


            function deleteContent(){
                mod_type='delete'
                document.getElementById('routenum').value=-1
                var data = getFormData();
                
                saveData(data)
                //mainModalMenuDiv.style.display='none'
                //editDiv.style.display='none';
                //modal.style.display='none'
                
            }

            // Function to display the modal dialog
            function showModal() {
                
                showRatingUi();
                mainModalMenuDiv.style.display='block'
                
                editDiv.style.display='none';
                modal.style.display = 'block' ;
                
            }
    
            // Function to hide the modal dialog
            function hideModal() {

                modal.style.display = "none";
            }
  
        function showRatingUi()
        {
            if (isLoggedIn)
            {
                document.getElementById('route-rating-div').style.display='block';
            }else{
                document.getElementById('route-rating-div').style.display='none';
            }
        }

        function hideRatigngUi()
        {
            document.getElementById('route-rating-div').style.display='none';
        }

  
        function addBefore(){
            mod_type='add_before';
            clearModal();
            hideRatigngUi();
            showEditDiv();
        }

        function addAfter(){
            mod_type='add_after';
            clearModal();
            hideRatigngUi();
            showEditDiv();
        }

        function clearModal(){
            document.getElementById('hidden_message').textContent='';
            const greenColor = '#aaffaa';
            document.getElementById('routeid').value = '';
            if (mod_type == 'add_before'){
                document.getElementById('routenum').value = currentRow.routenum-0.5;
            }else if (mod_type == 'add_after'){
                document.getElementById('routenum').value = parseInt(currentRow.routenum)+0.5;
            }
            document.getElementById('routenum').disabled = true;

            //document.getElementById('line').value = '';
            document.getElementById('colorfr').value = '#aaffaa';
            document.getElementById('color1').value = '#aaffaa';
            document.getElementById('color2').value = '#aaffaa';
                        
            //document.getElementById('color1-display').style.backgroundColor = '#aaffaa';
            //document.getElementById('color_modifier').value = 'solid';
            setColorModifier('solid');
            document.getElementById('grade').value = '';
            document.getElementById('name').value = '';
            document.getElementById('openedby').value = '';
            document.getElementById('opendate').value = '';
            document.getElementById('notes').value = '';

            document.getElementById('route-color1').style.background = greenColor;
           
            document.getElementById('route-name').innerHTML =  '';
            
            document.getElementById('route-routenum').innerHTML =  '';
            document.getElementById('route-grade').innerHTML =  '';
            modalBoxDiv.style.border="5px solid "+greenColor;
            //document.getElementById('color1').style.backgroundColor = greenColor;
        
        }


        function setColorModifier(color_modifier){
            if (color_modifier == 'solid'){
                
                document.getElementById('color_modifier_solid').checked = true;
            }else{
                document.getElementById('color_modifier_marble').checked = true;
            }
            //document.getElementById('color_modifier').value = color_modifier;
            //document.getElementById('color_modifier').checked = data.color_modifier=='solid';
            //document.getElementById('color_modifier').checked = data.color_modifier=='solid';
          updateColor2Visibility();
            
        }

        function getColorModifierValue(){
            color_modifier = ''
            Array.from(  document.getElementsByName('color_modifier')   ).forEach((element,index) =>
                {
                       if (true === element.checked) {
                        color_modifier= element.value;
                    } 
                });
                return color_modifier;
        }


        function routeDetail(data) {
        	//console.log("routeDetail.. "+data+" - ");
            currentRow=data;
            console.log('routeId '+data.id);
            var hatchColor = data.color1;
            var backgroundColor = 'transparent'; // or any other color
            var hatchedBackground = `repeating-linear-gradient(45deg, ${hatchColor}, ${hatchColor} 15px, ${backgroundColor} 5px, ${backgroundColor} 20px)`;
            var average_user_grade = data.average_user_grade || '';
            document.getElementById('routeid').value = data.id;
            document.getElementById('routenum').value = data.routenum;
            document.getElementById('line').value = data.line;
            document.getElementById('colorfr').value = data.colorfr;
            document.getElementById('color1').value = data.color1;
            document.getElementById('color2').value = data.color2;
            
            
            //document.getElementById('color1-display').style.backgroundColor = data.color1;
            //document.getElementById('color_modifier').value = data.color_modifier;
            setColorModifier(data.color_modifier);
            updateColor2Visibility();
            
            document.getElementById('grade').value = data.grade;
            document.getElementById('name').value = data.name;
            document.getElementById('openedby').value = data.openedby;
            document.getElementById('opendate').value = data.opendate;
            document.getElementById('notes').value = data.notes;

            if (data.color_modifier == 'marble') { 
              document.getElementById('route-color1').style.background = hatchedBackground;
            } else {
              document.getElementById('route-color1').style.background = data.color1;
            }

//            document.getElementById('route-color1').style.background = data.color1;
            document.getElementById('route-name').innerHTML = data.name;
            document.getElementById('route-routenum').innerHTML = data.routenum;
            // Protect against undefined/null average_user_grade so we don't render "undefined" in UI
            document.getElementById('route-grade').innerHTML = data.grade + average_user_grade;
            modalBoxDiv.style.border="5px solid "+data.color1;
            document.getElementById('route-openedby').innerHTML = data.openedby;
            document.getElementById('route-opendate').innerHTML = data.opendate;
            document.getElementById('route-notes').innerHTML = data.notes;
            document.getElementById('route-line').innerHTML = data.line;
            // Render aggregated non-editable stars (rating_avg) next to route name
            (function(){
              var starsEl = document.getElementById('route-stars-view');
              if (!starsEl) return;
              var avg = Number(data.rating_avg || 0);
              var count = Number(data.rating_count || 0);
              var rounded = Math.max(0, Math.min(3, Math.round(avg)));
              var html = '<div style="display:inline-flex; gap:2px;" title="'+avg.toFixed(2)+' / 3 ('+count+' votes)">';
              for (var i=1;i<=3;i++){
                var filled = i <= rounded;
                html += '<span style="font-size:22px; color:'+(filled?'#FFD600':'#ddd')+';">★</span>';
              }
              html += '</div>';
              starsEl.innerHTML = html;
            })();
            
            // this is a background on edit popup input field
            //document.getElementById('color1').style.backgroundColor = currentRow.color1;
            document.getElementById('hidden_message').textContent='';
          
            document.getElementById('grade_user').value = data.grade;
        }

        
        function colorChanged(tp){
            var color = document.getElementById('color1').value;
            //document.getElementById('route-color1').style.background = color;
            
            document.getElementById('color1').style.backgroundColor = color;
            modalBoxDiv.style.border="5px solid "+color;
            /*if (tp){
                color.close();
            }*/
        } 

        color1input = document.getElementById('color1');
        color1input.addEventListener("input", colorChanged(0), false);
        color1input.addEventListener("change", colorChanged(1), false);

        // Show/hide color2 based on color modifier (marble requires two colors)
        function updateColor2Visibility(){
          try {
            var val = getColorModifierValue();
            var lbl = document.getElementById('color2label');
            var inp = document.getElementById('color2input');
            if (!lbl || !inp) return;
            var show = (val === 'marble');
            lbl.style.display = show ? 'block' : 'none';
            inp.style.display = show ? 'block' : 'none';
          } catch(e) { console.warn('updateColor2Visibility failed', e); }
        }
        document.getElementById('color_modifier_solid').addEventListener('change', updateColor2Visibility);
        document.getElementById('color_modifier_marble').addEventListener('change', updateColor2Visibility);

    </script>
    














  



<div class="container-fluid">
    
   
    
    <div class="row">  
      
            <div class="col g-0">






    
                <div id="tabulator-table"></div>
            </div>
        </div>

    </div>
<br><br>

</div>


	<!-- Trigger the modal with a button -->


   


    <script>
        let routesTableConfig;
        var routes;
        var activitiesRecorded = 0;
        var usersRegistered = 0;
      
        function configureRoutesTable(userConfig)
        {
            const defaultConfig = {
                gymid: "{{gymid}}",
                routeListId: "{{routesid}}",
                groupBy: "grade",
        initialSort: [{ column: "grade", dir: "desc" }],
        // new flag replacing former Jinja template conditional user_can_edit_gym
        user_can_edit_gym: false
            };

            // Merge default settings with user-provided settings
            routesTableConfig = { ...defaultConfig, ...userConfig };

      // Show/hide edit controls based on config property
      const editControlsDiv = document.getElementById('edit-controls');
      if (editControlsDiv) {
        editControlsDiv.style.display = routesTableConfig.user_can_edit_gym ? 'inline-block' : 'none';
      }



          apiFetch(`/api1/gym/${routesTableConfig.gymid}`)
          .then(response => response.json())
          .then(data => {
              // use the retrieved data here
            //console.log(data);
            // set the gym-name span from data name param
            el = document.getElementById('gym_name');
            if (el != null){
                el.textContent = data.name;
            }


              
          })
          .catch(error => console.error(error));
      
          
          apiFetch(`/api1/gym/${routesTableConfig.gymid}/${routesTableConfig.routeListId}`)
          .then(response => response.json())
          .then(data => {
              // use the retrieved data here
              // console.log(data);p
              routes=data.routes
              renderTabulatorTable(routes);
              //console.log('creating qr code');
              //new QRCode(document.getElementById("qrcode"), "http://jindo.dev.naver.com/collie");
              
              //renderCarousel(routes);
          })
          .catch(error => console.error(error));
      

          apiFetch(`/api1/user`)
          .then(response => response.json())
          .then(data => {
              // use the retrieved data here
              console.log(data);
              // Explicit 401 handling: clear token and redirect
              

              if (Object.keys(data).length === 0) {
                // data is an empty object
              }
              else{
                isLoggedIn = true;
                showRatingUi();
              }
                
            }                
          )
          .catch(error => console.error(error));


          apiFetch(`/api1/activity/gym/${routesTableConfig.gymid}/routes/${routesTableConfig.routeListId}`)
          .then(response => response.json())
          .then(data => {
              // use the retrieved data here
                //console.log(data);
                if (Object.keys(data).length === 0) {
                    // data is an empty object
                }
                else{
                    activitiesRecorded = Object.keys(data).length;
                    //isLoggedIn = true;
                    //showRatingUi();
                }
                
            }                
          )
          .catch(error => console.error(error));


          apiFetch(`/api1/gym/${routesTableConfig.gymid}/users`)
          .then(response => response.json())
          .then(data => {
              // use the retrieved data here
                //console.log(data);
                if (Object.keys(data).length === 0) {
                    // data is an empty object
                    // remove div called users-div
                    var usersDiv = document.getElementById('users-div-col');
                    if (usersDiv == null){
                        return;
                    }
                    usersDiv.remove();
                }
                else{
                    usersRegistered = Object.keys(data).length;
                    usersDiv = document.getElementById('users-div');
                    if (usersDiv == null){
                        return;
                    }
                    // create div element
                    //var div = document.createElement('div');
                    // loop over usersRegistered and create a div for each user
                    for (var i = 0; i < usersRegistered; i++) {
                        //console.log(data[i]);
                        var user = data[i];
                        var userDiv = document.createElement('div');
                        // set class col on userDiv
                        userDiv.className = 'd-inline-flex focus-ring py-1 ms-1 mb-1 px-2 text-decoration-none border rounded-2';
                        userDiv.innerHTML = user['firstname']+'  &nbsp;';
                        // add pictureurl from user to div as an image
                        var img = document.createElement('img');
                        img.src = user['pictureurl'];
                        img.width = 30;
                        
                        // add the image to the div
                        userDiv.appendChild(img);
                        usersDiv.appendChild(userDiv);
                    }
                    //isLoggedIn = true;
                    //showRatingUi();
                }
                
            }                
          )
          .catch(error => console.error(error));

          


        }
      



      function renderCarousel(routes)
      {


      } 
      
      
    var table;
    
      function renderTabulatorTable(routesA)
      {
        var columns = [
          {title: "id", visible:false, field: "id", "responsive": 0 , resizable: false, minWidth:2, width:60, headerVertical:false},
          {title: "{{ reference_data['current_language'].route_num}}", visible:false, field: "routenum", "responsive": 0 , minWidth:2, width:60, headerVertical:false},
          {title: "#", field: "line", "responsive": 0 , minWidth:2, width:70, headerVertical:false, resizable:false,
            formatter:function(cell, formatterParams, onRendered){
                return `${cell.getValue()} <sup>${cell.getRow().getData().routenum}<sup>`
                     //"<img src='/image/cad113945fd14e589feac6464b4ce792logo-ESN-HD-copy-1030x1030.png' width='20'>";
            },
        
        },
          {title: "{{ reference_data['current_language'].color }}", field: "color1", 
           "responsive": 0 , minWidth:10, 
           formatter:function(cell, formatterParams, onRendered){ 
              return getColorSVGDiv(cell.getValue(), cell.getRow().getData().color2, cell.getRow().getData().color_modifier, '90px', '40px');
            },
        
            formatterPrint:function(cell, formatterParams, onRendered){
              return getColorSVGDiv(cell.getValue(), cell.getRow().getData().color2, cell.getRow().getData().color_modifier, '90px', '40px');
            },
        },

          {title: "{{ reference_data['current_language'].grade }}", field: "grade", "responsive": 0 , minWidth:10, headerVertical:false, 
          formatter:function(cell, formatterParams, onRendered){
                return `${cell.getValue()}   ${cell.getRow().getData().average_user_grade || ''} `
                     //"<img src='/image/cad113945fd14e589feac6464b4ce792logo-ESN-HD-copy-1030x1030.png' width='20'>";
            },

          },
          {title: "{{ reference_data['current_language'].rating }}", field: "rating_avg", "responsive": 0, minWidth:10, headerVertical:false,
           formatter:function(cell){
              var avg = Number(cell.getValue() || 0);
              var count = Number(cell.getRow().getData().rating_count || 0);
              // Round avg to nearest integer for 3-star visual, but keep tooltip precise
              var rounded = Math.max(0, Math.min(3, Math.round(avg)));
              var html = '<div style="display:inline-flex; gap:2px;" title="'+(avg.toFixed(2))+' / 3 ('+count+' votes)">';
              for (var i=1;i<=3;i++){
                var filled = i <= rounded;
                html += '<span style="font-size:18px; color:'+(filled?'#FFD600':'#ddd')+';">★</span>';
              }
              html += '</div>';
              return html;
           }
          },
          
          {title: "{{ reference_data['current_language'].route_name }}", field: "name", "responsive": 0 , minWidth:10},
          /*{title: "Difficulty", field: "difficulty_rating", "responsive": 0 , minWidth:10, formatter:"star", formatterParams:{
            stars:5,
            }},*/
          {title: "{{ reference_data['current_language'].route_opened_by}}", field: "openedby", "responsive": 2 , minWidth:10},
          {title: "{{ reference_data['current_language'].route_opened_date}}", field: "opendate", "responsive": 3},
          {title: "{{ reference_data['current_language'].notes}}", field: "notes", "responsive": 5 , formatter:"plaintext"}
          ];
      
          // Create the Tabulator table
        table = new Tabulator("#tabulator-table", {
            printHeader:"<h1>SKALA3MA - {{ gym['name'] }} - {{ routes['name'] }} </h1>", // set header content on printed table
            printFooter:"<h3></h3>", // set footer content on printed table
            printAsHtml:true,
            //printStyled:true, //copy Tabulator styling to HTML table
            printRowRange:"all",
            printConfig:{
                //columnHeaders:false, //do not include column headers in printed table
                columnGroups:false, //do not include column groups in column headers for printed table
                rowGroups:false, //do not include row groups in printed table
                //columnCalcs:false, //do not include column calcs in printed table
                //dataTree:false, //do not include data tree in printed table
                //formatCells:true, //show raw cell values without formatter
            },
            groupBy: routesTableConfig.groupBy,
            groupToggleElement:"header",
            groupStartOpen:false,
            //groupBy:"routenum",
            //groupStartOpen:function(value, count, data, group){
                //value - the value all members of this group share
                //count - the number of rows in this group
                //data - an array of all the row data objects in this group
                //group - the group component for the group

                //return false; //all groups with more than three rows start open, any with three or less start closed
            //},
            groupHeader:function(value, count, data, group){
                //value - the value all members of this group share
                //count - the number of rows in this group
                //data - an array of all the row data objects in this group
                //group - the group component for the group
                colorDivs = "";
                // Loop over the data array
                for (let i = 0; i < count; i++) {
                    // Concatenate the result of getColorSVGDiv to colorDivs
                    colorDivs += getColorSVGDiv(data[i].color1, data[i].color2, data[i].color_modifier, '55px', '26px',data[i].grade)+
                    `${data[i].average_user_grade||''}  &nbsp;&nbsp;&nbsp;`;
                }
                // Wrap the colorDivs in an encompassing div with flexbox styling
                const encompassingDiv = `<div style="display: flex; gap: 3px;">${colorDivs}</div>`;

                return "<span style='font-size: 1.0rem'> {{reference_data['current_language'].line}}   " +value +
                    encompassingDiv+ "</span>";
            },
            columns: columns,
            data: routesA ,
            layout:"fitDataStretch",
            //layout: "fitDataFill",
            //layout: "fitColumns",
            movableRows: false,
            selectable: 1,
            //responsiveLayout:"collapse",
            responsiveLayout:"hide",
            //responsiveLayout:"fitColumns",
            //responsiveLayout:"collapse",
            //movableColumns: true, 
            //responsiveLayoutCollapseStartOpen:true,
            formatter:"responsiveCollapse", headerSort:false,
            rowFormatter:function(row){
            //if(row.getData().line % 2 == 0){
                //row.getElement().style.backgroundColor = "#dddddd";
                //row.getElement().classList.add("celled"); //mark rows with age less than 18 with a warning state;
              //  row.getElement().style.backgroundColor = "#f1f1f1";
            
            //}else{
              //  row.getElement().style.backgroundColor = "#ffffff";
            
            //}
            },

              /*rowContextMenu:[
              {
                label:"Edit Row",
                action:function(e, row){
                    row.delete();
                }
                },
                {
                    label:"Delete Row",
                    action:function(e, row){
                        row.delete();
                    }
                },
            ]*/
          });

          table.on("rowClick", function(e, row){
            routeDetail(row.getData());
            showModal();
            row.toggleSelect();
          });

          /*if (currentRow !== undefined)
          {
            //table.selectRow(Math.abs(parseInt(currentRow.routenum)));
            table.selectRow(2);
          }*/

        printTable = document.getElementById("print-table");
        if (printTable !== null)
        {
            printTable.addEventListener("click", function(){
                table.print(false, true);
            });
        }
        

        table.on("tableBuilt", function(){
            table.on("dataSorting", function(sorters){
            //sorters - an array of the sorters currently applied
            
            table.setGroupBy(false); 
            if (sorters.length >0 && sorters[0].field == 'line'){
                table.setGroupBy('line');
            }else{
                table.setGroupBy(false);
            }
            
        });
        });        
      }


        function getFormData() {
          const formData = {};

          const routeid = document.getElementById('routeid').value;
          console.log('getFormData routeid '+routeid);
          
          formData['id'] = routeid;
          
          const routenum = document.getElementById('routenum').value;
          formData['routenum'] = routenum;
          
          const line = document.getElementById('line').value;
          formData['line'] = line;
          
          const colorfr = document.getElementById('colorfr').value;
          formData['colorfr'] = colorfr;
          
          const color1 = document.getElementById('color1').value;
          formData['color1'] = color1;

          const color2 = document.getElementById('color2').value;
          formData['color2'] = color2;
          
          //const colorModifier = document.getElementById('color_modifier').value;
          const colorModifier = getColorModifierValue();
          
          formData['color_modifier'] = colorModifier;
          
          const grade = document.getElementById('grade').value;
          formData['grade'] = grade;
          
          const name = document.getElementById('name').value;
          formData['name'] = name;
          
          const openedBy = document.getElementById('openedby').value;
          formData['openedby'] = openedBy;
          
          const openDate = document.getElementById('opendate').value;
          formData['opendate'] = openDate;
          
          const notes = document.getElementById('notes').value;
          formData['notes'] = notes;

            formData['route_finish_status'] = routeFinishStatus;

            const route_grade_user = document.getElementById('grade_user').value;
            formData['grade_user'] = route_grade_user;
            // Optional 0-3 star rating from route-rating-div (radio inputs)
            const checkedStar = document.querySelector('#route-stars input[name="route_stars"]:checked');
            if(checkedStar){
              formData['route_stars'] = parseInt(checkedStar.value || '0');
            } else {
              formData['route_stars'] = 0;
            }
          
            //const notes_user = document.getElementById('notes_user').value;
            formData['notes_user'] = '';

          const jsonData = JSON.stringify(formData);
          
          return jsonData;
        }
      
      
        function addRoute() {
          const id = document.getElementById('routeid').value;
          const routenum = parseInt(document.getElementById('routenum').value);
          const line = document.getElementById('line').value;
          const colorfr = document.getElementById('colorfr').value;
          const color1 = document.getElementById('color1').value;
          const color2 = document.getElementById('color2').value;
          const color_modifier = document.getElementById('color_modifier').value;
          const grade = document.getElementById('grade').value;
          const name = document.getElementById('name').value;
          const openedby = document.getElementById('openedby').value;
          const opendate = document.getElementById('opendate').value;
          const notes = document.getElementById('notes').value;
      
          const route = {
            id,
            routenum,
            line,
            colorfr,
            color1,
            color2,
            color_modifier,
            grade,
            name,
            openedby,
            opendate,
            notes
          };
      
          // insert the new route into the array
          routes.splice(routenum, 0, route);
      
          console.log('Route added:', route);
          console.log('Routes array:', routes);
        }

        function saveLine() {
            var data = getFormData();
            saveData(data)
        }

        function addActivityRoute() {
            var data = getFormData();
            //console.log('saving new route to activity '+mod_type)    
            //fetch('/api1/gym/{{gymid}}/{{routesid}}/'+mod_type, {
            apiFetch(`/api1/activity/${routesTableConfig.gymid}/${routesTableConfig.routeListId}/saveone`, {
                mode: 'no-cors',
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    console.log('error response',response.json)
                    //return Promise.reject(response);
                    throw new Error('Network response was not ok');
                }
                //return response.json();
            })
            .then(data => {
                console.log('Response from saving route');
                console.log(data)
                //routes=data.routes
                //renderTabulatorTable(routes);
                //table.replaceData(routes);
                hideModal()
      
            })
            .catch(error => {
                console.error('catch error:', error);
                document.getElementById('hidden_message').textContent="{{ reference_data['current_language']['error5315'] }}";

                
                
            });
          }


        //mode: 'no-cors',
        function saveData(inputData){
            console.log('saving data '+mod_type)    
            //fetch('/api1/gym/{{gymid}}/{{routesid}}/'+mod_type, {
            apiFetch(`/api1/gym/${routesTableConfig.gymid}/${routesTableConfig.routeListId}/saveone`, {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify(inputData)
            })
            .then(response => {
                
                if (!response.ok) {
                    //console.log('error response',response.json)
                    //console.log(response.json)
                    //return Promise.reject(response);
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                //console.log('inputData:', inputData);
                
                routes=data.routes
                showAlert('routes_saved', 'success')
                //renderTabulatorTable(routes);
                table.updateOrAddData(routes);

                hideModal()
      
            })
            .catch(error => {
                console.error('catch error:', error);
                document.getElementById('hidden_message').textContent="{{ reference_data['current_language']['error5315'] }}";

                
                
            });
            }


        function rateRoute(){
                mod_type='rate'
                var data = getFormData();
                //console.log('rating route '+mod_type)    
            //fetch('/api1/gym/{{gymid}}/{{routesid}}/'+mod_type, {
            apiFetch(`/api1/gym/${routesTableConfig.gymid}/${routesTableConfig.routeListId}/rate`, {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response && response.status === 401) {
                try { clearJwtToken && clearJwtToken(); } catch(_) {}
                try {
                  const currentPath = window.location.pathname || '';
                  if (currentPath !== '/loginchoice') {
                    window.location.assign('/loginchoice');
                  }
                } catch(_) {}
                return; // stop further processing
              }
                if (!response.ok) {
                    //console.log('error response',response.json)
                    //console.log(response.json)
                    //return Promise.reject(response);
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                //console.log(data);
                showAlert('rating_saved', 'success')
                
                hideModal()
                
            })
            .catch(error => {
                console.error('catch error:', error);
                document.getElementById('hidden_message').textContent="{{ reference_data['current_language']['error5315'] }}";
                
            });
            return false;
        }

      </script>
      
      
      

