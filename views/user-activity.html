
{% extends "skala3ma-layout.html" %}

{% block topcontent %}

{% endblock %}

	{% block secondarycontent %}

    {% include "user-menu.html" %}



    <style>
        /* Style for the modal dialog container */
        .modal-container {
            display: none;
            position: fixed;
            z-index: 1023;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            /*justify-content: left;*/
            background-color: rgba(0, 0, 0, 0.4);
        }

        /* Style for the modal dialog box */
        .modal-box {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width:max-content;
            
            display: flex;
            
            
            align-items: center;
            text-align: center;
            font-size: 14px;
            color: #333;
        }

        /* Style for the close button */
        .close-button {
            position: absolute;
            top: 30px;
            right: 30px;
            font-size: 35px;
            color: #aaa;
            font-weight: bold;
            cursor: pointer;
        }

        /* Adopted controversial routes styles for activities display */
        .disagreements-grid { display:grid; grid-template-columns:1fr minmax(140px,200px) minmax(130px,280px); gap:.5rem .75rem; align-items:start; font-size:.85rem; }
        .disagreements-grid .head { font-weight:700; text-transform:uppercase; letter-spacing:.7px; font-size:.58rem; opacity:.7; }
        .dis-cell { background:#f1f3f4; padding:.45rem .45rem; border-radius:10px; cursor:pointer; }
        .route-dis-flex { display:flex; gap:.6rem; align-items:flex-start; flex-wrap:nowrap; }
        .route-dis-flex .route-meta { flex:1 1 auto; font-size:.85rem; line-height:1.15; }
        .route-dis-flex .route-meta .route-name { font-size:1.1rem; font-weight:500; margin-bottom:.15rem; }
        .route-dis-flex .route-meta .route-date { font-size:.8rem; opacity:.75; }
        .route-dis-flex .route-meta .route-gym { opacity:.95; font-size:.6rem; }
        .chip-grade { display:inline-block; padding:.18rem .35rem; border-radius:14px; font-size:.8rem; font-weight:600; letter-spacing:.3px; background:#eceff1; margin:.18rem .25rem .18rem 0; }
        /* Status badges copied from activities.html */
        .badge { display:inline-block; padding:.3rem .55rem; border-radius:6px; font-size:.6rem; font-weight:600; letter-spacing:.5px; background:#eceff1;  }
       
        .badge.climbs { background:#41ac49; margin-left:.35rem; margin-right: .45rem; }
        .badge.flashes { background:#efcc05; margin-left: 0; margin-right: .75rem; }
        .badge.attempts { background:#d73038;margin-left: .4rem; margin-right: .45rem; }
        .status-icon { width:20px; height:20px; vertical-align:middle;  }
        .status-badge { font-size:.7rem; display:inline-flex; align-items:center; }
        /* Mobile wrap override */
        @media (max-width: 700px) {
          .disagreements-grid { display:flex; flex-wrap:wrap; }
          .disagreements-grid .head { flex:1 1 140px; min-width:140px; }
          .disagreements-grid .dis-cell.route-detail { flex:1 1 100%; min-width:100%; }
          .disagreements-grid .dis-cell:not(.route-detail) { flex:1 1 160px; min-width:140px; }
        }
    </style>

    


    
    <div id="modal" class="modal-container">
        
        <div id="modal-box" class="modal-box">
           
            <form action="#" enctype="multipart/form-data"  method="POST">
                <style>
                    .form-row-heading {
                      display: flex;
                      justify-content: center;
                      align-items: baseline;
                      margin: 10px;
                      font-size: 20px;
                      color: #292424;
                      font-weight: bold;
                      vertical-align: bottom;
                    }
                    .form-row {
                      display: flex;
                      justify-content: center;
                      align-items: center;
                      margin: 10px;
                    }
                  
                    .form-row label {
                      text-align: right;
                      margin-right: 6px;
                      flex: 1;
                    }
                  
                    .form-row input,
                    .form-row select,
                    .form-row textarea {
                      flex: 1;
                    }
                  </style>

            <div id="hidden_message" class="form-row" style=" font: bold 24px;color: red; align-content: center;"></div>
           
            <div id="mainModalMenu">
                
            
                <div class="form-row">
                <span class="close-button" onclick="hideModal()">&times;</span>
                <h2 data-translate-key="add_activity">add activity transaltion</h2>
                </div>
                <div class="form-row">
                <label for="gym_id" data-translate-key="where">where translation</label>
                <select name="gym_id" id="gym_id">
                    <option value="-1" size="20" >{{reference_data['clubs'][gym_id]}} -- {{gym_id}}</option>
                    
        
                </select>
                </div>
                <div class="form-row">
           
                        <label for="activity_name">Name:</label>
                        <input type="text" id="activity_name" name="activitiy_name" value="{{ reference_data['current_language'].activity}}" size="40">
                      </div>
                      <div class="form-row">
                    
                <label for="date">{{ reference_data['current_language'].date }}:</label> <input id='date' name="date" size="30" type="date" value="{{today}}"/>
                        </div>


                <button id='editbutton' type="button" class="btn btn-primary btn-lg" onclick="saveData();" data-translate-key="create">Create</button>&nbsp;
                
                <button id='cancelbutton' type="button" class="btn btn-secondary  btn-lg" onclick="closeDialog()" data-translate-key="cancel">Cancel</button>
            </div> 
            </div>

                  
                    </form>
            </form>
            
        </div>
        
    </div>




	<div name='container'>


		<div class="text-center heading-section" >
            
        <h3><span data-translate-key="activities">activities translation</span>
               <a href="#" onClick="showModal()"><i class="bi bi-plus-circle-fill" style="font-size: 3rem; color: #53be6b;"></i></a>
            </h3>
		</div>
            
		<div class="container text-center heading-section" >
        	
            <div  id="activitiesChart"></div>
        </div>
            
        
    <div class="container heading-section">
      <!-- Activities will be rendered in a grid styled like controversial routes -->
      <div id="activities"></div>
    </div>
              
             
			 

		</div>


        <br>
    </div>

</div>
<!-- fh5co-blog-section -->

</div>



<script>
    // Get the modal dialog container
    var modal = document.getElementById("modal");
    //var mainModalMenuDiv = document.getElementById('mainModalMenu');
    var modalBoxDiv = document.getElementById('modal-box');
    var currentRow;
    var mod_type;


    function showEditDiv(){
        mainModalMenuDiv.style.display='none'
        editDiv.style.display='block';
    }

    function editContent(){
        mod_type='save'
        showEditDiv();
        return false;
    }

    function deleteContent(){
        mod_type='delete'
        document.getElementById('routenum').value=-1
        var data = getFormData();
        
        postData(data)
        //mainModalMenuDiv.style.display='none'
        //editDiv.style.display='none';
        //modal.style.display='none'
        
    }

    // Function to display the modal dialog
    function showModal() {
        
        //mainModalMenuDiv.style.display='block'
        //editDiv.style.display='none';
        modal.style.display = "block";
    }

    // Function to hide the modal dialog
    function hideModal() {
        modal.style.display = "none";
    }

    function clearModal(){
        document.getElementById('hidden_message').textContent='';
        
  // Set default activity name from template language without breaking JS string quoting
  document.getElementById('activity_name').value = "{{ reference_data['current_language'].activity }}";
        
    }


    function closeDialog(){
        clearModal();
        hideModal();
    }
    
    function saveData() {
            var data = getFormData();
            if (Object.keys(data).length === 0) 
                return;
            postData(data)

        }

    function getFormData() {
        const formData = {};

        //console.log('getFormData')
        
        const gym_id = document.getElementById('gym_id').value;
        formData['gym_id'] = gym_id;
        if (gym_id == -1){
            document.getElementById('hidden_message').textContent="{{ reference_data['current_language']['error5324'] }}";
            return {};
        }

        const activity_name = document.getElementById('activity_name').value;
        formData['activity_name'] = activity_name;

        const date = document.getElementById('date').value;
        formData['date'] = date;
  
        return formData;
    }
        

    function postJsonDataToServer() {
        var data = getFormData();
        if (data == {}) return;
            postData(data)

        
        
    }

    function postData(data){
        fetch('/api1/activity', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                //console.log('error response',response.json)
                //return Promise.reject(response);
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // redirect to the new activity page
            window.location.href = "/activities/"+data.id;
    
        })
        .catch(error => {
            console.error('catch error:', error);
            document.getElementById('hidden_message').textContent="{{ reference_data['current_language']['error5315'] }}";

            
            
        });

       
    }


    
var activities;
var gyms;

function getData()
{
    fetch(`/api1/gyms`)
    .then(response => response.json())
    .then(data => {
        // use the retrieved data here
        //console.log("retrieved data in activities.js")
        //console.log(data);
        gyms=data
        processGyms(gyms);
    })
    .catch(error => console.error(error));
    

    fetch(`/api1/myactivities`)
    .then(response => response.json())
    .then(data => {
        // use the retrieved data here
        console.log("retrieved data in user-activity.html")
        console.log(data);
        activities=data
        processActivities(activities);

            

    })
    .catch(error => console.error(error));

}

function processActivities(activities)
{
  if (!activities || !activities.activities) return;
  if (activities.activities.length === 0){
     showModal();
  }
  getActivityChart();
  processActivityChartData(activities);
  // build grid container & headers
  const container = document.getElementById('activities');
  container.textContent='';
  const grid = document.createElement('div');
  grid.className = 'disagreements-grid';
  const headers = [
    { key:'activity_details', text:'' },
    { key:'attempts', text:'' },
    { key:'gym', text:'' }
  ];
  headers.forEach(h=>{
    const hd = document.createElement('div');
    hd.className='head';
    hd.dataset.translateKey = h.key;
    hd.textContent = h.text;
    grid.appendChild(hd);
  });
  activities.activities.forEach(a=> addActivityEntry(a, grid));
  container.appendChild(grid);
}

function processGyms(gyms)
{
    for (var i = 0; i < gyms.length; i++) {
        //add gym option to gym_id select field
        var option = document.createElement("option");
        option.text = gyms[i].name;
        option.value = gyms[i].id;
        var select = document.getElementById("gym_id");
        select.appendChild(option);

    }	  
}	


function addActivityEntry(activity, gridRef){
  if(!activity) return;
  const targetGrid = gridRef || document.querySelector('#activities .disagreements-grid');
  if(!targetGrid) return;
  const dateVal = activity.date || '';
  // Details cell (route-detail style for visual prominence)
  const cDetails = document.createElement('div'); cDetails.className='dis-cell route-detail';
  cDetails.addEventListener('click', ()=> location.href = `/activities/${activity.id}`);
  const flex = document.createElement('div'); flex.className='route-dis-flex';
  const meta = document.createElement('div'); meta.className='route-meta';
  meta.innerHTML = `<div class='route-name'><a href="/activities/${activity.id}">${activity.name || 'Unnamed Activity'}</a></div>
    <div class='route-date'>${dateVal}</div>
    `;
  flex.appendChild(meta); cDetails.appendChild(flex); targetGrid.appendChild(cDetails);
  // Attempts/status breakdown cell with badges & icons
  const cAttempts = document.createElement('div'); cAttempts.className='dis-cell';
  const counts = {climbed:0, flashed:0, attempted:0};
  (activity.attempts||[]).forEach(at => { if(at && counts.hasOwnProperty(at.status)) counts[at.status]++; });
  const statusesOrder = ['climbed','flashed','attempted'];
  statusesOrder.forEach(st => {
    const img = document.createElement('img'); img.className='status-icon'; img.src = statusIcon(st); img.alt = st;
    const badge = document.createElement('span'); badge.className = `badge ${st==='climbed'?'climbs':(st==='flashed'?'flashes':'attempts')} status-badge`;
    badge.textContent = ` ${counts[st]} `; // leading space for separation after icon
    cAttempts.appendChild(img); cAttempts.appendChild(badge);
  });
  cAttempts.addEventListener('click', ()=> location.href = `/activities/${activity.id}`); targetGrid.appendChild(cAttempts);
  // Gym cell
  const cGym = document.createElement('div'); cGym.className='dis-cell'; cGym.textContent = activity.gym_name || ''; cGym.addEventListener('click', ()=> location.href = `/activities/${activity.id}`); targetGrid.appendChild(cGym);
}

// Reuse status icons mapping from activities.html
function statusIcon(status){
  if(status==='climbed') return '/public/images/1398911_correct_mark_success_tick_valid_icon.png';
  if(status==='attempted') return '/public/images/4125784_confounded_confused_emoji_emotion_fail_icon.png';
  if(status==='flashed') return '/public/images/2682840_bolt_elictricity_light_lightning_storm_icon.png';
  return '/public/images/1398911_correct_mark_success_tick_valid_icon.png';
}


    var dateChartOptions;

    function getActivityChart()
    {
        dateChartOptions = {
          series: [{
          name: 'your_route_count',
          data: [
            ]
        },{
          name: 'average_route_count',
          data: [
            ]
        }
    ],
          chart: {
          type: 'bar',
          height: 280
        },
        plotOptions: {
          bar: {
            horizontal: false,
            columnWidth: '100%',
            endingShape: 'rounded'
          },
        },
        dataLabels: {
          enabled: false
        },
        stroke: {
          show: true,
          width: 2,
          colors: ['transparent']
        },
        xaxis: {
          categories: [],
        },
        yaxis: {
          title: {
            text: ''
          },
          labels: {
            show: true,
            formatter: function (val) {
              return val + " oo ";
            }
          }
        },
        fill: {
          opacity: 1
        },
        tooltip: {
          y: {
            formatter: function (val) {
              return "" + getTranslation(val) 
            },
            title: {
              formatter: (seriesName) => getTranslation(seriesName),
          },
          }
        },
        labels: {
            show: false,
            formatter: function (val) {
              return val + "%";
            }
          },
          
        legend: {
          position: 'bottom',
          horizontalAlign: 'center',
          offsetX: 40,
          formatter: function( val) {
            return getTranslation(val) + " "
            }
        }
        };
        //var datesChart = new ApexCharts(document.getElementById("activitychart"), dateChartOptions);
        //datesChart.render()
    }

    function processActivityChartData(activities)
	{
		//console.log('here2');
		//console.log(fullresponse['F0']);
		//
        if (activities == undefined) return;
        stats=activities.stats

        dateChartOptions.series[0].data= stats['routes_done']
        dateChartOptions.series[1].data= stats['routes_avg']
        dateChartOptions.xaxis.categories= stats['dates']
        dateChartOptions.xaxis.tickAmount = 5
        dateChartOptions.xaxis.labels = {
             'rotate': 0
        }
        
        var datesChart = new ApexCharts(document.getElementById("activitiesChart"), dateChartOptions);
        datesChart.render();
    }



window.addEventListener('load', () => {
  
  var now = new Date();
  document.getElementById('date').value  = now.toISOString().split('T')[0];
  getData();
  
});





</script>



					


	
{% endblock %}