


{% extends "skala3ma-layout.html" %}

{% block topcontent %}

{% endblock %}

	{% block secondarycontent %}




    <style>
        /* Style for the modal dialog container */
        .modal-container {
            display: none;
            justify-content: center;
            
            position: fixed;
            z-index: 1023;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        /* Style for the modal dialog box */
        .modal-box {
            background-color: hsl(0, 0%, 100%);
            /*margin: 2%;*/
            margin: auto;
            padding: 15px;
            border: 1px solid #888;
            vertical-align: middle; 
            /*width:max-content;*/
            width:fit-content;
            
            display:flex;
            
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 14px;
            color: #333;
        }

        /* Style for the close button */
        .close-button {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 30px;
            color: #aaa;
            font-weight: bold;
            cursor: pointer;
        }
    </style>

    


    
    <div id="modal" class="modal-container">
        
        <div id="modal-box" class="modal-box">
           
                <style>
                    .form-row-heading {
                      display: flex;
                      justify-content: center;
                      align-items: baseline;
                      margin: 2px;
                      font-size: 20px;
                      color: #292424;
                      font-weight: bold;
                      vertical-align: bottom;
                    }
                    .form-row {
                      display: flex;
                      justify-content: center;
                      align-items: center;
                      margin: 0px;
                    }
                  
                    .form-row label {
                      text-align: right;
                      margin-right: 6px;
                      flex: 1;
                    }
                  
                    .form-row input,
                    .form-row select,
                    .form-row textarea {
                      flex: 1;
                    }
                  </style>

            <div id="hidden_message" class="form-row" style=" font: bold 24px;color: red; align-content: center;"></div>
            <span class="close-button" onclick="hideModal()">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>

            <div id="tabulator-table" class="form-row"></div>


                  
            
        </div>
        
    </div>

    <!-- Static attempt edit modal created at load time so translation keys exist before replaceTranslations() runs -->
    <div id="attemptEditModal" class="modal-container" style="display:none;">
        <div class="modal-box" style="max-width:520px; width:90%; flex-direction:column; align-items:stretch;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                 <h4 id="attemptModalTitle" style="margin:0; font-size:1.2rem;"></h4>
                 <button type="button" onclick="closeAttemptModal()" class="btn btn-sm btn-outline-secondary">âœ•</button>
            </div>
            <div id="attemptRouteInfo" class="route-info" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:8px;">
                <span id="attemptRouteColor"></span>
                <span id="attemptRouteGrade" class="badge bg-secondary" style="font-size:0.9rem;"></span>
                <span id="attemptRouteName" style="font-weight:600; font-size:0.95rem;"></span>
            </div>
            <form id="attemptEditForm" onsubmit="submitAttemptModal(event)">
                <div class="mb-3">
                    <label class="form-label" data-translate-key="status">status translation</label>
                    <div class='status-picker btn-group w-100' role='group' style='display:flex; gap:8px; justify-content:space-between;'>
                        <button type='button' class='btn btn-light status-btn' data-status='attempted' title='Attempted'><img src="/public/images/4125784_confounded_confused_emoji_emotion_fail_icon.png" width="40" height="40" alt="attempted" /></button>
                        <button type='button' class='btn btn-light status-btn' data-status='climbed' title='Climbed'><img src="/public/images/1398911_correct_mark_success_tick_valid_icon.png" width="40" height="40" alt="climbed" /></button>
                        <button type='button' class='btn btn-light status-btn' data-status='flashed' title='Flashed'><img src="/public/images/2682840_bolt_elictricity_light_lightning_storm_icon.png" width="40" height="40" alt="flashed" /></button>
                    </div>
                    <input type='hidden' id='attemptModalStatus' />
                </div>
                <div class="row g-2 mb-3">
                    <label class="form-label" data-translate-key="grade">grade translation</label>
                    <select id="attemptModalGrade" class="form-select" style="font-size:1rem; font-weight:600; color:#40ad48;">
                        <option value="?">?</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4a">4a</option>
                        <option value="4b">4b</option>
                        <option value="4c">4c</option>
                        <option value="5a">5a</option>
                        <option value="5a+">5a+</option>
                        <option value="5b">5b</option>
                        <option value="5b+">5b+</option>
                        <option value="5c">5c</option>
                        <option value="5c+">5c+</option>
                        <option value="6a">6a</option>
                        <option value="6a+">6a+</option>
                        <option value="6b">6b</option>
                        <option value="6b+">6b+</option>
                        <option value="6c">6c</option>
                        <option value="6c+">6c+</option>
                        <option value="7a">7a</option>
                        <option value="7a+">7a+</option>
                        <option value="7b">7b</option>
                        <option value="7b+">7b+</option>
                        <option value="7c">7c</option>
                        <option value="7c+">7c+</option>
                        <option value="8a">8a</option>
                        <option value="8a+">8a+</option>
                        <option value="8b">8b</option>
                        <option value="8b+">8b+</option>
                        <option value="8c">8c</option>
                        <option value="8c+">8c+</option>
                        <option value="9a">9a</option>
                        <option value="9a+">9a+</option>
                        <option value="9b">9b</option>
                        <option value="9b+">9b+</option>
                        <option value="9c">9c</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label" data-translate-key="notes">notes translation</label>
                    <textarea id="attemptModalNote" class="form-control" rows="3" placeholder=".."></textarea>
                </div>
                <div style="display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap;">
                    <button type="submit" class="btn btn-success flex-grow-1" data-translate-key="save">save translation</button>
                    <button type="button" id="attemptModalDeleteBtn" onclick="deleteAttemptFromModal()" class="btn btn-danger flex-grow-1" style="display:none;" data-translate-key="Delete">delete translation</button>
                    <button type="button" onclick="closeAttemptModal()" class="btn btn-secondary flex-grow-1" data-translate-key="cancel">cancel translation</button>
                </div>
            </form>
        </div>
    </div>




<script>
    // Global constants
    // Derive activity id from URL path: /activities/<id>
    const ACTIVITY_ID = (function(){
        const parts = window.location.pathname.split('/').filter(Boolean);
        const idx = parts.indexOf('activities');
        if(idx !== -1 && parts.length > idx+1){ return parts[idx+1]; }
        // fallback: query param ?activity_id=...
        const qp = new URLSearchParams(window.location.search).get('activity_id');
        return qp || '';
    })();

    let queryParams = new URLSearchParams(window.location.search);

    let queryRouteid = queryParams.get("routeid"); // return john
    //console.log("queryRouteid: "+queryRouteid);

    // Get the modal dialog container
    var modal = document.getElementById("modal");
    //var mainModalMenuDiv = document.getElementById('mainModalMenu');
    var modalBoxDiv = document.getElementById('modal-box');
    var currentRow;
    var mod_type;


    function showEditDiv(){
        //mainModalMenuDiv.style.display='none'
        //editDiv.style.display='block';
    }

    function editContent(){
        mod_type='save'
        showEditDiv();
        return false;
    }

// Function to display the modal dialog
function showModal() {
        // default open: show table (route list), hide detail panel
        //if(mainModalMenuDiv){ mainModalMenuDiv.style.display='none'; }
        const tab = document.getElementById('tabulator-table');
        if(tab){ tab.style.display='block'; }
        // use flex so centering works (justify-content set in CSS)
        modal.style.display = "flex";
    }

    // Function to hide the modal dialog
    function hideModal() {
        modal.style.display = "none";
    }

    function hideTable(){
        const tab = document.getElementById('tabulator-table');
        if(tab){ tab.style.display='none'; }
    }

    function clearModal(){
        document.getElementById('hidden_message').textContent='';
        
        document.getElementById('activity_name').value = 'My activity';
        
        
    }


    function closeDialog(){
        //clearModal();
        hideModal();
    }
    

    function deleteActivity()
    {
    fetch(`/api1/activity/${ACTIVITY_ID}`,
        { method: 'DELETE'})
        .then(response => response.json())
        .then(data => {
            // use the retrieved data here
            window.location.href = "/myactivities";
        })
        .catch(error => console.error(error));
    }



    var gym_id;
    var routesIndex = {}; // map route_id -> route metadata from activity.routes
    var activity; // lean activity object
    var table;
      
      function getData()
      {
        const gymid = "{{gym['gym_id']}}";
        const routeid = "{{routes['id']}}";
    
                fetch(`/api1/activity/${ACTIVITY_ID}`)
                    .then(r => r.json())
                    .then(data => handleActivityResponse(data))
                    .catch(error => console.error(error));
    

        fetch(`/api1/gym/{{gym['id']}}/`)
        .then(response => response.json())
        .then(data => {
            // use the retrieved data here
            //console.log(data);
            routes=data.routes
            renderGymRoutesTabulatorTable(routes);
            
              
    
        })
        .catch(error => console.error(error));
      }
    
    

    getData();
    

    function renderGymRoutesTabulatorTable(routesA)
      {
        var columns = [
            {title: "{{ reference_data['current_language'].route_num}}", visible:false, field: "routenum", "responsive": 0 , minWidth:2, width:60, headerVertical:false},
            {title: "{{ reference_data['current_language'].line }}", field: "line", "responsive": 0 , minWidth:2, width:60, headerVertical:false,
                formatter:function(cell, formatterParams, onRendered){
                    return `${cell.getValue()} <sup>${cell.getRow().getData().routenum}</sup>`;
                },
            
            },
            
            {title: "{{ reference_data['current_language'].color }}", field: "color1", 
            "responsive": 0 , minWidth:10, 
            formatter:function(cell, formatterParams, onRendered){ 
                return getColorSVGDiv(cell.getValue(), cell.getRow().getData().color_modifier, '100px', '50px');
                },
            
                formatterPrint:function(cell, formatterParams, onRendered){
                return getColorSVGDiv(cell.getValue(), cell.getRow().getData().color_modifier, '100px', '50px');
                },
            },
            {title: "{{ reference_data['current_language'].grade }}", field: "grade", "responsive": 0 , minWidth:10, headerVertical:false},
            {title: "{{ reference_data['current_language'].route_name }}", field: "name", "responsive": 1 , minWidth:10},
            {title: "{{ reference_data['current_language'].route_opened_by}}", field: "openedby", "responsive": 2 , minWidth:10},
            {title: "{{ reference_data['current_language'].route_opened_date}}", field: "opendate", "responsive": 2},
            {title: "{{ reference_data['current_language'].notes}}", field: "notes", "responsive": 1 , formatter:"plaintext"}
            ];
        
          // Create the Tabulator table
        table = new Tabulator("#tabulator-table", {
            columns: columns,
            data: routesA ,
            layout:"fitDataStretch",
            //layout: "fitDataFill",
            movableRows: true,
            selectable: 1,
            responsiveLayout:"collapse",
            //responsiveLayout:"fitColumns",
            //movableColumns: true, 
            responsiveLayoutCollapseStartOpen:false,
            groupBy: "line",
            groupToggleElement:"header",
            groupStartOpen:false,
            //groupBy:"routenum",
            //groupStartOpen:function(value, count, data, group){
                //value - the value all members of this group share
                //count - the number of rows in this group
                //data - an array of all the row data objects in this group
                //group - the group component for the group

                //return false; //all groups with more than three rows start open, any with three or less start closed
            //},
            groupHeader:function(value, count, data, group){
                //value - the value all members of this group share
                //count - the number of rows in this group
                //data - an array of all the row data objects in this group
                //group - the group component for the group
                colorDivs = "";
                // Loop over the data array
                for (let i = 0; i < count; i++) {
                    // Concatenate the result of getColorSVGDiv to colorDivs
                    colorDivs += getColorSVGDiv(data[i].color1, data[i].color_modifier, '55px', '20px')+
                    ` &nbsp;&nbsp;&nbsp;`;
                }
                // Wrap the colorDivs in an encompassing div with flexbox styling
                const encompassingDiv = `<div style="display: flex; gap: 3px;">${colorDivs}</div>`;

                return "<span style='font-size: 1.0rem'> {{reference_data['current_language'].line}}   " +value +
                    encompassingDiv+ "</span>";
            },
            formatter:"responsiveCollapse", headerSort:true,
            rowFormatter:function(row){
            if(row.getData().line % 2 == 0){
                    //row.getElement().style.backgroundColor = "#dddddd";
                    //row.getElement().classList.add("celled"); //mark rows with age less than 18 with a warning state;
                    row.getElement().style.backgroundColor = "#f1f1f1";
                
                }else{
                    row.getElement().style.backgroundColor = "#ffffff";
                
                }
                },

              /*rowContextMenu:[
              {
                label:"Edit Row",
                action:function(e, row){
                    row.delete();
                }
                },
                {
                    label:"Delete Row",
                    action:function(e, row){
                        row.delete();
                    }
                },
            ]*/
          });

          table.on("rowClick", function(e, row){
                        // Instead of showing route detail modal, open attempt edit modal directly for new attempt
                        openAttemptModalForRoute(row.getData());
          });

          table.on("tableBuilt", function(){
            checkAndOpenAddRouteActivity();
          });

          if (currentRow !== undefined)
          {
            //table.selectRow(Math.abs(parseInt(currentRow.routenum)));
            //table.selectRow(2);
          }
      
      }

      function checkAndOpenAddRouteActivity()
      {
        if (queryRouteid == undefined)
        {
            return;
        }
        console.log("checkAndOpenAddRouteActivity: "+queryRouteid);
        
        rows = table.searchRows("id", "=", queryRouteid);

        if (rows == undefined || rows.length == 0)
        {
            return;
        }
        
        console.log(rows);
        console.log(rows[0]);
        console.log(rows[0].getData());
        showModal();
        gymRouteDetail(rows[0].getData());


      } 
      
    
      var formData = {};

      function gymRouteDetail(data) {
            resetFlashImage();
            console.log("gymRouteDetail ");
            console.log(data);
            currentRow=data;
            document.getElementById('route-routenum').innerHTML = data.routenum;
            document.getElementById('route-grade').innerHTML = data.grade;
            document.getElementById('route-name').innerHTML = data.name;
            document.getElementById('route-color1').style.background = data.color1;
            document.getElementById('route-grade-user').value = data.grade; 
            formData = {};
            formData['route_id'] = data.id;
            // switch from table view to route detail view inside same modal
            hideTable();
            //if(mainModalMenuDiv){
            //    mainModalMenuDiv.style.display='block';
            //}
            // ensure modal is visible (if invoked directly)
            if(modal && modal.style.display==='none'){
                modal.style.display='flex';
            }
    }


    function handleActivityResponse(data){
        activity = data;
        // Build route index; if lean form routes are distinct; if legacy flattened (no attempts) we can synthesize attempts later if needed
        routesIndex = {};
        (activity.routes || []).forEach(r => { if(r.id) routesIndex[r.id] = r; });
        // If response lacks attempts but has flattened routes (legacy) convert them to pseudo attempts
        if(!activity.attempts && Array.isArray(activity.routes)){
            activity.attempts = activity.routes.map(r => ({
                route_id: r.id,
                status: r.status || 'attempted',
                user_grade: r.user_grade || r.grade,
                note: r.note || '',
                attempt_time: r.attempt_time || r.datetime || ''
            }));
        }
    const nameSpan = document.getElementById('activityName');
    if(nameSpan){ nameSpan.textContent = activity.name || ''; }
        document.getElementById('activityDate').innerHTML = '<a href="/gyms/'+activity.gym_id+'">'+(activity.gym_name||'')+'</a> - '+(activity.starttime||'');
        renderAttempts();
    }

    function deleteRoute(attemptId)
    {
        //console.log("delete attempt  "+attemptId);
        if (attemptId == undefined || attemptId.length == 0)
        {
            return;
        }
        // optimistic removal: hide row immediately
        const rowEl = document.querySelector(`#attemptsBody tr td a[onclick*="${attemptId}"]`)?.parentElement?.parentElement;
        if(rowEl){ rowEl.style.opacity='0.4'; }
        fetch(`/api1/activity/${ACTIVITY_ID}/route/${attemptId}`, { method: 'DELETE'})
          .then(r => r.json())
          .then(data => {
             if(data.error){ console.error(data.error); return; }
             handleActivityResponse(data);
          })
          .catch(error => console.error(error));
    }

    // Save (or create) an attempt for the currently selected route inside this activity.
    // Called by the Save button with a status (e.g. 'climbed' or 'flashed').
    function saveData(status){
        // Legacy modal save: create new attempt if none exists for route, otherwise update existing attempt
        try {
            if(!currentRow || !currentRow.id){
                console.error('No current route selected');
                return;
            }
            const routeId = currentRow.id;
            const userGrade = (document.getElementById('route-grade-user')?.value || '').trim();
            const note = (document.getElementById('notes')?.value || '').trim();
            const chosenStatus = status || 'attempted';
            const existingAttempt = (activity?.attempts||[]).find(a => a.route_id === routeId);
            if(existingAttempt && (existingAttempt.attempt_id || existingAttempt.route_id)){
                const attemptId = existingAttempt.attempt_id || existingAttempt.route_id; // fallback to legacy route id
                const payload = { status: chosenStatus, user_grade: userGrade, note }; 
                fetch(`/api1/activity/${ACTIVITY_ID}/attempt/${attemptId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(r=>r.json())
                .then(data => {
                    if(data.error){
                        document.getElementById('hidden_message').textContent = data.error;
                        return;
                    }
                    handleActivityResponse(data);
                    document.getElementById('hidden_message').textContent = '{{ reference_data["current_language"].saved if reference_data["current_language"].get("saved") else "Saved" }}';
                }).catch(err => {
                    console.error('update attempt failed', err);
                    document.getElementById('hidden_message').textContent = 'error_saving';
                });
            } else {
                // create new attempt via POST /activity/<activity_id>
                const createPayload = {
                    gym_id: activity?.gym_id,
                    routes_id: activity?.routes_id,
                    route_id: routeId,
                    note: note,
                    route_finish_status: chosenStatus, // map status -> route_finish_status legacy field
                    'route-grade-user': userGrade
                };
                fetch(`/api1/activity/${ACTIVITY_ID}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(createPayload)
                }).then(r=>r.json()).then(data => {
                    if(data.error){
                        document.getElementById('hidden_message').textContent = data.error;
                        return;
                    }
                    // data is singular activity? add_activity_route returns activity.to_dict()
                    handleActivityResponse(data);
                    document.getElementById('hidden_message').textContent = '{{ reference_data["current_language"].saved if reference_data["current_language"].get("saved") else "Saved" }}';
                }).catch(err => {
                    console.error('create attempt failed', err);
                    document.getElementById('hidden_message').textContent = 'error_saving';
                });
            }
        } catch(ex){
            console.error('saveData exception', ex);
        }
    }

    function statusIcon(status){
        if(status === 'climbed') return '<img src="/public/images/1398911_correct_mark_success_tick_valid_icon.png" width="30" height="30" alt="climbed">';
        if(status === 'flashed') return '<img src="/public/images/2682840_bolt_elictricity_light_lightning_storm_icon.png" width="30" height="30" alt="flashed">';
        return '<img src="/public/images/4125784_confounded_confused_emoji_emotion_fail_icon.png" width="30" height="30" alt="attempted">';
    }

    function renderAttempts(){
        const tbody = document.getElementById('attemptsBody');
        if(!tbody) return;
        tbody.innerHTML='';
        const attempts = activity?.attempts || [];
        attempts.forEach(att => {
            const route = routesIndex[att.route_id] || {};
            const disagreement = (att.user_grade && route.grade && att.user_grade !== route.grade);
            const attemptKey = att.attempt_id || att.route_id;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class='route-cell'>
                    <div class='route-cell-inner'>
                        <span class='route-color'>${getColorSVGDiv(route.color1 || '', route.color_modifier || 'solid', '50px','25px')}</span>
                        <span class='route-grade'>${route.grade || ''}</span>
                        <span class='route-name'>${route.name || ''}</span>
                    </div>
                </td>
                <td class='status-cell'>${statusIcon(att.status)}</td>
                <td class='user-grade-cell'>${disagreement?`<i>${att.user_grade}</i>`:(att.user_grade||'')}</td>
                <td class='note-cell'><i>${att.note || ''}</i></td>
                <td class='text-nowrap action-cell'>
                    <a href='#' onclick="openAttemptModal('${attemptKey}');return false;" title='Edit attempt'>
                        <i class='bi bi-pencil-square' style='font-size: 1.3rem; color:#198754;'></i>
                    </a>
                </td>`;
            tbody.appendChild(tr);
        });
    }

    
    
        
    function enterEditActivityName(){
        const current = activity?.name || '';
        document.getElementById('activityNameInput').value = current;
        document.getElementById('activityName').style.display='none';
        document.getElementById('activityNameEdit').style.display='none';
        document.getElementById('activityNameEditControls').style.display='inline-block';
    }
    function cancelEditActivityName(){
        document.getElementById('activityName').style.display='inline';
        document.getElementById('activityNameEdit').style.display='inline';
        document.getElementById('activityNameEditControls').style.display='none';
    }
    function saveActivityName(){
        const newName = document.getElementById('activityNameInput').value.trim();
        if(!newName){ return; }
        fetch(`/api1/activity/${ACTIVITY_ID}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: newName })
        }).then(r=>r.json()).then(data => {
            if(data.error){ console.error(data.error); return; }
            activity = data;
            document.getElementById('activityName').textContent = activity.name || '';
            cancelEditActivityName();
        }).catch(err => console.error(err));
    }


        // ---------- POPUP ATTEMPT EDIT (Mobile Friendly) ----------
        let attemptModalEl;
    let currentRouteId = null; // Used when creating a brand new attempt
        function ensureAttemptModal(){
            // Modal now exists statically in DOM; just cache reference
            if(!attemptModalEl){
                attemptModalEl = document.getElementById('attemptEditModal');
            }
        }
        let currentAttemptKey = null;
        function openAttemptModal(attemptKey){
                ensureAttemptModal();
                currentAttemptKey = attemptKey;
                const attemptObj = (activity.attempts||[]).find(a => (a.attempt_id||a.route_id) === attemptKey);
                if(!attemptObj){ console.error('Attempt not found'); return; }
                const route = routesIndex[attemptObj.route_id] || {};
                document.getElementById('attemptModalStatus').value = attemptObj.status;
                document.getElementById('attemptModalGrade').value = attemptObj.user_grade || '';
                
                document.getElementById('attemptModalNote').value = attemptObj.note || '';
        // Populate route info section
        const colorEl = document.getElementById('attemptRouteColor');
        const gradeEl = document.getElementById('attemptRouteGrade');
        const nameEl = document.getElementById('attemptRouteName');
        if(colorEl){ colorEl.innerHTML = getColorSVGDiv(route.color1 || '', route.color_modifier || 'solid', '55px','25px'); }
        if(gradeEl){ gradeEl.textContent = route.grade || ''; }
        if(nameEl){ nameEl.textContent = route.name || route.routenum || ''; }
        const delBtn = document.getElementById('attemptModalDeleteBtn');
        if(delBtn){ delBtn.style.display=''; }
                attemptModalEl.style.display='flex';
                attemptModalEl.querySelectorAll('.status-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.getAttribute('data-status') === attemptObj.status);
                        btn.onclick = () => {
                                attemptModalEl.querySelectorAll('.status-btn').forEach(b=>b.classList.remove('active'));
                                btn.classList.add('active');
                                document.getElementById('attemptModalStatus').value = btn.getAttribute('data-status');
                        };
                });
        }

    // Open attempt modal for a route that may not yet have an attempt (creation flow)
    function openAttemptModalForRoute(routeData){
        ensureAttemptModal();
        if(!routeData || !routeData.id){ console.error('Route data missing'); return; }
        currentRouteId = routeData.id; // keep for creation
        const route = routesIndex[routeData.id] || routeData;
        // Prefill fields
        document.getElementById('attemptModalStatus').value = 'climbed';
        document.getElementById('attemptModalGrade').value = (route.grade || '');
        
        document.getElementById('attemptModalNote').value = '';
        // Populate route info section for add/edit
        const colorEl = document.getElementById('attemptRouteColor');
        const gradeEl = document.getElementById('attemptRouteGrade');
        const nameEl = document.getElementById('attemptRouteName');
        if(colorEl){ colorEl.innerHTML = getColorSVGDiv(route.color1 || '', route.color_modifier || 'solid', '55px','25px'); }
        if(gradeEl){ gradeEl.textContent = route.grade || ''; }
        if(nameEl){ nameEl.textContent = route.name || route.routenum || ''; }
        const delBtn = document.getElementById('attemptModalDeleteBtn');
        if(delBtn){ delBtn.style.display = 'none'; }
        attemptModalEl.style.display='flex';
        attemptModalEl.querySelectorAll('.status-btn').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-status') === 'climbed');
            btn.onclick = () => {
                attemptModalEl.querySelectorAll('.status-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('attemptModalStatus').value = btn.getAttribute('data-status');
            };
        });
        // Hide the route selection modal if open
        if(modal) modal.style.display='none';
    }
        function closeAttemptModal(){
                if(attemptModalEl) attemptModalEl.style.display='none';
                currentAttemptKey = null;
        }
        function submitAttemptModal(e){
            e.preventDefault();
            // For new attempt, currentAttemptKey may be null; fallback to currentRouteId
            let attemptObj = null;
            if(currentAttemptKey){
                attemptObj = (activity.attempts||[]).find(a => (a.attempt_id||a.route_id) === currentAttemptKey);
            }
            const routeId = attemptObj?.route_id || currentRouteId;
            if(!routeId){ console.error('route_id missing (creation/update)'); return; }
            const statusVal = document.getElementById('attemptModalStatus').value;
            const userGradeVal = document.getElementById('attemptModalGrade').value.trim();
            const noteVal = document.getElementById('attemptModalNote').value.trim();
            if(attemptObj && (attemptObj.attempt_id || attemptObj.route_id)){
                // UPDATE existing attempt
                const attemptId = attemptObj.attempt_id || attemptObj.route_id;
                const payload = { status: statusVal, user_grade: userGradeVal, note: noteVal };
                fetch(`/api1/activity/${ACTIVITY_ID}/attempt/${attemptId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }).then(r=>r.json()).then(data => {
                    if(data.error){ console.error(data.error); return; }
                    closeAttemptModal();
                    handleActivityResponse(data);
                }).catch(err => console.error(err));
            } else {
                // CREATE new attempt via POST
                const createPayload = {
                    gym_id: activity?.gym_id,
                    routes_id: activity?.routes_id,
                    route_id: routeId,
                    note: noteVal,
                    route_finish_status: statusVal,
                    'route-grade-user': userGradeVal
                };
                fetch(`/api1/activity/${ACTIVITY_ID}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(createPayload)
                }).then(r=>r.json()).then(data => {
                    if(data.error){ console.error(data.error); return; }
                    closeAttemptModal();
                    handleActivityResponse(data);
                }).catch(err => console.error(err));
            }
        }
        function deleteAttemptFromModal(){
        // Allow delete only if existing attempt
        if(!currentAttemptKey){ return; }
        const attemptObj = (activity.attempts||[]).find(a => (a.attempt_id||a.route_id) === currentAttemptKey);
        const routeId = attemptObj?.route_id;
        if(!routeId){ console.error('route_id missing for delete'); return; }
                fetch(`/api1/activity/${ACTIVITY_ID}/route/${routeId}`, { method:'DELETE' })
                    .then(r=>r.json()).then(data => {
                        if(data.error){ console.error(data.error); return; }
                        closeAttemptModal();
                        handleActivityResponse(data);
                    }).catch(err=>console.error(err));
        }
</script>




	<div name='activity_detail_content'>

	 
					<div class="text-center heading-section">
					
				<h3>
                    <span id="activityName"></span>
                    <span id="activityNameEdit" style="cursor:pointer; margin-left:8px;" title="Edit name" onclick="enterEditActivityName()">
                        <i class="bi bi-pencil-square" style="font-size:1.1rem;"></i>
                    </span>
                    <span id="activityNameEditControls" style="display:none; margin-left:8px;">
                        <input id="activityNameInput" type="text" style="padding:6px 14px; font-size:2.2rem; font-weight:600; width:clamp(340px,70%,900px); border:1px solid #bbb; border-radius:8px; line-height:1.1;" />
                        <button class="btn btn-sm btn-primary" onclick="saveActivityName()">Save</button>
                        <button class="btn btn-sm btn-secondary" onclick="cancelEditActivityName()">Cancel</button>
                    </span>
                </h3>
                         <div id="activityDate"></div>
                                 
                         
					</div>
                    
		<div class="container">
			<div class="row row-bottom-padded-md">

<style>
/* Responsive styling for attempts table */
table.table thead th { white-space:nowrap; }
.route-cell-inner { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.route-color { flex:0 0 auto; }
.route-grade { font-weight:600; color:#222; flex:0 0 auto; }
.route-name { flex:1 1 40px; min-width:140px; }
.status-cell img { display:block; margin:auto; }
@media (max-width: 720px) {
    .route-cell-inner { flex-direction:column; align-items:flex-start; gap:2px; }
    .route-grade { font-size:0.95rem; }
    .route-name { font-size:0.9rem; }
    .note-cell { font-size:0.75rem; }
    .user-grade-cell { font-size:0.8rem; }
    table.table thead { font-size:0.75rem; }
    table.table i.bi-plus-circle-fill { font-size:2.2rem !important; }
}
@media (max-width: 480px) {
    .action-cell i { font-size:1.1rem !important; }
    
}
</style>

                
                
<table class="table thead-dark table-hover">
    <thead>
        <tr>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
        </tr>
    </thead>
    <tbody id="attemptsBody"></tbody>
    <tfoot>
        <tr><td class="text-center" colspan="5">
            <a href="#" onClick="showModal()"> <i class="bi bi-plus-circle-fill" style="font-size: 2.5rem; color: #40ad48;"></i></a>
        </td></tr>
    </tfoot>
</table>

</div>
<div class="text-center heading-section">
    <button id='deletebutton' type="button" class="btn btn-danger  btn-sm" onclick="deleteActivity()">{{ reference_data['current_language'].remove }} {{ reference_data['current_language'].activity }}</button>
    

</div>




			</div>

		</div>
	</div>




{% endblock %}
