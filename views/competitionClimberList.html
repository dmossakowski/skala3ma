{% extends "skala3ma-layout.html" %}

{% block topcontent %}


{% endblock %}


	{% block secondarycontent %}

		{% include "competition-menu.html" %}

		<script>
			// Default to empty strings when Jinja variables are undefined
			alertMessage = {{ alert_message | default('') | tojson }};
			infoMessage = {{ info_message  | default('') | tojson }};

            //console.log("Alert message: ", alertMessage);

            if (alertMessage != '') {
                showAlert(alertMessage, 'danger')
            }
            if (infoMessage != '') {
                showAlert(infoMessage, 'info')
            }
        </script>
        <!-- competitionClimberList.html -->
		<!--div id="fh5co-blog-section" class="fh5co-section-gray"	-->
					<div class="container">
                        <div class="text-center heading-section">


						<br>
						{{ reference_data['current_language'].competition_climber_list }} 
                        <h3>
								{{competition['name'] }} - {{ competition['date']| strftime(format='short')}}</h3>


						<font color="red">	{{ reference_data['current_language'][error_code] }} </font>
                        <font color="red">	{{ reference_data['current_language'][error_code] }} </font>

					    </div>
                    </div>









<!--onclick="location.href='/competitionRoutesEntry/{{ competitionId }}/climber/{{ climberId}}'"-->
<style>
/* Minimal responsive layout for climbers list */
#climberList { display:flex; flex-direction:column; gap:.5rem; }
.climber-row { display:flex; flex-direction:column; padding:.5rem .75rem; border:1px solid #ddd; border-radius:4px; background:#fff; }
@media (min-width:600px){ .climber-row { flex-direction:row; align-items:center; } }
.climber-name { font-size:1.2rem; font-weight:500; display:flex; align-items:center; gap:.5rem; }
.presence-badge { display:inline-block; width:1.35rem; height:1rem; line-height:1rem; text-align:center; border-radius:50%; font-size:.85rem; font-weight:600; }
.presence-badge.present { background:#198754; color:#fff; }
.presence-badge.absent { background:#6c757d; color:#fff; }
.climber-meta { display:flex; flex-wrap:wrap; gap:.75rem; font-size:.9rem; margin-top:.25rem; }
@media (min-width:600px){ .climber-meta { margin-top:0; margin-left:1rem; } }
/* registration status badge */
.reg-status { padding:0 .6rem; border-radius:12px; font-size:.6rem; font-weight:600; letter-spacing:.5px; text-transform:uppercase; }
.reg-status.registered { background:#198754; color:#fff; }
.reg-status.waitlist { background:#ffc107; color:#000; }
.reg-status.hide { display:none; }
/* thin bars indicator for routes (no goal background) */
.routes-bars { display:flex; align-items:flex-end; gap:2px; height:16px; margin-top:2px; }
.routes-bar { width:3px; background:#198754; border-radius:2px 2px 0 0; animation:grow .4s ease-out; }
@keyframes grow { from { transform:scaleY(0); } to { transform:scaleY(1); } }
/* presence indicator: static check/cross badge */
/* uses existing .presence-badge present/absent styles above */
.tabulator-cell[data-field="present"] { padding:.5rem; }
</style>
<div id="climberTable"></div>
<script>
document.addEventListener('DOMContentLoaded', function(){
  // Polyfill for very old browsers
  if (!Object.entries) {
    Object.entries = function(obj){
      var keys = Object.keys(obj), i = keys.length, res = new Array(i);
      while (i--) res[i] = [keys[i], obj[keys[i]]];
      return res;
    };
  }

  function waitForDeps(timeout=8000, interval=100){
    return new Promise(function(resolve, reject){
      var start = Date.now();
      (function check(){
        var ok = (typeof Tabulator !== 'undefined') &&
                 (typeof apiFetchJson === 'function' || typeof apiFetch === 'function');
        if (ok) return resolve();
        if (Date.now() - start >= timeout) return reject(new Error('Dependencies timeout'));
        setTimeout(check, interval);
      })();
    });
  }

  function fmtDate(val){
    if(val == null) return '';
    try{
      var d = (typeof val === 'number') ? new Date(val*1000) : new Date(val);
      if(isNaN(d.getTime())) return '';
      return d.toLocaleDateString();
    } catch(e){ return ''; }
  }

  function renderFallbackList(comp){
    var tableEl = document.getElementById('climberTable');
    if (!tableEl || !comp || !comp.climbers) return;
    var html = '<ul class="list-unstyled">';
    Object.entries(comp.climbers).forEach(function(pair){
      var c = pair[1] || {};
      var name = c.name || '';
      var club = c.club || '';
      var routes = Array.isArray(c.routesClimbed) ? c.routesClimbed.length : 0;
      html += '<li class="climber-row"><div class="climber-name">'+name+
              '</div><div class="climber-meta"><span>'+club+
              '</span><span>'+routes+' {{ reference_data["current_language"].routes }}</span></div></li>';
    });
    html += '</ul>';
    tableEl.innerHTML = html;
  }

  function getCompId(){
    var path = window.location.pathname;
    var m = path.match(/competitionClimberList\/([^\/]+)/) || path.match(/competition\/([^\/]+)/);
    var competitionIdFromJinja = {{ competition['id'] | default('') | tojson }};
    return (m && m[1]) ? m[1] : (competitionIdFromJinja || '');
  }

  function fetchCompetition(competitionId){
    return (typeof apiFetchJson === 'function')
      ? apiFetchJson('/api1/competition/'+competitionId+'?remove=routesClimbed2')
      : apiFetch('/api1/competition/'+competitionId).then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); });
  }

  function initClimberTable(){
    var tableEl = document.getElementById('climberTable');
    if(!tableEl) return;

    var competitionId = getCompId();
    if(!competitionId){ console.error('Cannot determine competitionId'); return; }

    function getCatKey(calc_type, competition_type, age_category_type, category){
      var key = age_category_type+'_' + competition_type+'_' + category;
      return 'competition_category_' + key;
    }

    var table = new Tabulator(tableEl, {
      layout: "fitDataStretch",
      responsiveLayout: "collapse",
      responsiveLayoutCollapseStartOpen: true,
      initialSort: [{column: "name", dir: "asc"}],
      columns: [
        {title: "{{ reference_data['current_language'].name }}", field: "name", responsive: 0, headerSort: true,
          formatter: function(cell){
            var d = cell.getRow().getData();
            var url = '/competitionRoutesEntry/'+competitionId+'/climber/'+d.id;
            var val = cell.getValue() || '';
            return '<a href="'+url+'"><b>'+val+'</b></a>';
          }
        },
        {title: "{{ reference_data['current_language'].registered }}", field: "status", responsive: 1,
          formatter: function(cell){
            var v = (cell.getValue() || '').toLowerCase();
            var reg_text = (typeof getTranslation === 'function' ? getTranslation('registered') : '{{ reference_data["current_language"].registered }}');
            var wait_text = (typeof getTranslation === 'function' ? getTranslation('waitlist') : '{{ reference_data["current_language"].waitlist }}');
            if(v === 'registered') return '<span class="reg-status registered show">'+reg_text+'</span>';
            if(v === 'waitlist') return '<span class="reg-status waitlist show">'+wait_text+'</span>';
            return '';
          }
        },
        {title: "{{ reference_data['current_language'].Present }}", field: "present", responsive: 2, hozAlign: "center", width: 120,
          formatter: function(cell){
            var isPresent = !!cell.getValue();
            var presentText = "{{ reference_data['current_language'].Present }}";
            var absentText = "{{ reference_data['current_language'].Absent }}";
            var label = isPresent ? presentText : absentText;
            var symbol = isPresent ? '✓' : '✗';
            return '<span class="presence-badge '+(isPresent ? 'present' : 'absent')+'" aria-label="'+label+'" title="'+label+'">'+symbol+'</span>';
          }
        },
        {title: "{{ reference_data['current_language'].registered_date }}", field: "registeredOn", responsive: 3},
        {title: "{{ reference_data['current_language'].club }}", field: "club", responsive: 4},
        {title: "{{ reference_data['current_language'].category }}", field: "category", responsive: 5},
        {title: "{{ reference_data['current_language'].sex }}", field: "sex", responsive: 6},
        {title: "{{ reference_data['current_language'].routes }}", field: "routes", responsive: 7, hozAlign: "right",
          formatter: function(cell){
            var routeCount = cell.getValue() || 0;
            return '<div class="routes-bars" aria-label="'+routeCount+' {{ reference_data["current_language"].routes_climbed }}" title="'+routeCount+' {{ reference_data["current_language"].routes_climbed }}">'+routeCount+'</div>';
          }
        }
      ],
      rowClick: function(e, row){
        var d = row.getData();
        window.location.href = '/competitionRoutesEntry/'+competitionId+'/climber/'+d.id;
      }
    });

    fetchCompetition(competitionId)
      .then(function(comp){
        var rows = [];
        if(comp && comp.climbers){
          Object.entries(comp.climbers).forEach(function(pair){
            var climberId = pair[0];
            var c = pair[1] || {};
            var routeCount = Array.isArray(c.routesClimbed) ? c.routesClimbed.length : 0;
            var rs = (c.registration_status || '').toLowerCase();
            var catKey = getCatKey(comp.calc_type, comp.competition_type, comp.age_category_type, c.category);
            var catLabel = (typeof getTranslation === 'function') ? (getTranslation(catKey) || '') : '';
            rows.push({
              id: climberId,
              name: c.name || '',
              sex: c.sex || '',
              club: c.club || '',
              category: catLabel,
              routes: routeCount,
              registeredOn: fmtDate(c.registration_timestamp),
              present: !!c.present,
              status: rs.indexOf('wait') >= 0 ? 'Waitlist' : (rs.indexOf('register') >= 0 ? 'Registered' : '')
            });
          });
        }
        if (rows.length > 0) { table.updateOrAddData(rows); }
      })
      .catch(function(err){ console.error('Failed to load competition', err); });
  }

  var competitionId = getCompId();
  if(!competitionId) return;

  waitForDeps()
    .then(function(){
      if (typeof Tabulator === 'undefined') {
        // Fallback render if Tabulator missing
        fetchCompetition(competitionId).then(renderFallbackList).catch(function(e){ console.error('Fallback render failed', e); });
      } else {
        initClimberTable();
      }
    })
    .catch(function(){
      // As a last resort, render a minimal list without Tabulator
      fetchCompetition(competitionId).then(renderFallbackList).catch(function(e){ console.error('Fallback render failed', e); });
    });
});
</script>









			</div>
		</div>
		<!-- fh5co-blog-section -->

	</div>
		</div>

{% endblock %}