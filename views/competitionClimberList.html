


{% extends "skala3ma-layout.html" %}

{% block topcontent %}


{% endblock %}


	{% block secondarycontent %}

		{% include "competition-menu.html" %}

		<script>
			// Default to empty strings when Jinja variables are undefined
			alertMessage = {{ alert_message | default('') | tojson }};
			infoMessage = {{ info_message  | default('') | tojson }};

            console.log("Alert message: ", alertMessage);

            if (alertMessage != '') {
                showAlert(alertMessage, 'danger')
            }
            if (infoMessage != '') {
                showAlert(infoMessage, 'info')
            }
        </script>
        <!-- competitionClimberList.html -->
		<!--div id="fh5co-blog-section" class="fh5co-section-gray"	-->
					<div class="container">
                        <div class="text-center heading-section">


						<br>
						<h3>{{ reference_data['current_language'].competition_climber_list }} <br>
								{{competition['name'] }} - {{ competition['date']| strftime(format='short')}}</h3>


						<font color="red">	{{ reference_data['current_language'][error_code] }} </font>
                        <font color="red">	{{ reference_data['current_language'][error_code] }} </font>

					    </div>
                    </div>








{% if competition is not none and competition is not undefined  %}

<!--onclick="location.href='/competitionRoutesEntry/{{ competitionId }}/climber/{{ climberId}}'"-->
<style>
/* Minimal responsive layout for climbers list */
#climberList { display:flex; flex-direction:column; gap:.5rem; }
.climber-row { display:flex; flex-direction:column; padding:.5rem .75rem; border:1px solid #ddd; border-radius:4px; background:#fff; }
@media (min-width:600px){ .climber-row { flex-direction:row; align-items:center; } }
.climber-name { font-size:1.2rem; font-weight:500; display:flex; align-items:center; gap:.5rem; }
.presence-badge { display:inline-block; width:1.35rem; height:1.25rem; line-height:1.25rem; text-align:center; border-radius:50%; font-size:.85rem; font-weight:600; }
.presence-badge.present { background:#198754; color:#fff; }
.presence-badge.absent { background:#6c757d; color:#fff; }
.climber-meta { display:flex; flex-wrap:wrap; gap:.75rem; font-size:.9rem; margin-top:.25rem; }
@media (min-width:600px){ .climber-meta { margin-top:0; margin-left:1rem; } }
/* registration status badge */
.reg-status { padding:0 .6rem; border-radius:12px; font-size:.6rem; font-weight:600; letter-spacing:.5px; text-transform:uppercase; }
.reg-status.registered { background:#198754; color:#fff; }
.reg-status.waitlist { background:#ffc107; color:#000; }
.reg-status.hide { display:none; }
/* thin bars indicator for routes (no goal background) */
.routes-bars { display:flex; align-items:flex-end; gap:2px; height:16px; margin-top:2px; }
.routes-bar { width:3px; background:#198754; border-radius:2px 2px 0 0; animation:grow .4s ease-out; }
@keyframes grow { from { transform:scaleY(0); } to { transform:scaleY(1); } }
</style>
<div id="climberList"></div>
<script>
(function(){
	if (typeof apiFetchJson !== 'function' && typeof apiFetch !== 'function') { console.error('apiFetch/apiFetchJson global helper missing'); return; }

	const container = document.getElementById('climberList');
	if(!container) return;

	// Determine competition ID from URL or Jinja fallback
	const path = window.location.pathname;
	let match = path.match(/competitionClimberList\/([^\/]+)/);
	if(!match){ match = path.match(/competition\/([^\/]+)/); }
	const competitionIdFromJinja = {{ competition['id'] | default('') | tojson }};
	const competitionId = (match && match[1]) ? match[1] : (competitionIdFromJinja || '');
	if(!competitionId){ console.error('Cannot determine competitionId'); return; }

	function createEl(tag, cls){ const el = document.createElement(tag); if(cls) el.className = cls; return el; }
	function textEl(tag, text, cls){ const el = createEl(tag, cls); el.textContent = text; return el; }
	function getCatKey(compType, category){ const prefix = (compType === 0) ? 'adult' : 'youth'; return `competition_category_${prefix}_${category}`; }
	function fmtDate(val){
		if(val == null) return '';
		try{
			const d = (typeof val === 'number') ? new Date(val*1000) : new Date(val);
			if(isNaN(d.getTime())) return '';
			return d.toLocaleDateString();
		} catch(e){ return ''; }
	}

	const fetchComp = (typeof apiFetchJson === 'function')
		? apiFetchJson(`/api1/competition/${competitionId}`)
		: apiFetch(`/api1/competition/${competitionId}`).then(r => { if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); });

	fetchComp
		.then(comp => {
			if(!comp || !comp.climbers){ container.textContent = ''; return; }
			container.textContent = '';
			const entries = Object.entries(comp.climbers);
			entries.forEach(([climberId, c]) => {
				const row = createEl('div', 'climber-row');
				const nameRow = createEl('div', 'climber-name');
				const metaRow = createEl('div', 'climber-meta');

				// Name + link
				const nameLink = document.createElement('a');
				nameLink.href = `/competitionRoutesEntry/${competitionId}/climber/${climberId}`;
				const nameBold = document.createElement('b');
				nameBold.textContent = c.name || '';
				nameLink.appendChild(nameBold);
				nameRow.appendChild(nameLink);

				// Registration status badges
				const rs = (c.registration_status || '').toLowerCase();
				const registered = createEl('span', `reg-status registered ${ (rs.includes('register') && !rs.includes('wait')) ? 'show' : 'hide' }`);
				registered.setAttribute('data-translate-key', 'registered');
				registered.title = 'Registered';
				registered.textContent = typeof getTranslation === 'function' ? (getTranslation('registered') || '') : '';
				nameRow.appendChild(registered);

				const waitlist = createEl('span', `reg-status waitlist ${ rs.includes('wait') ? 'show' : 'hide' }`);
				waitlist.setAttribute('data-translate-key', 'waitlist');
				waitlist.title = 'Waitlist';
				waitlist.textContent = typeof getTranslation === 'function' ? (getTranslation('waitlist') || 'waitlist-key') : 'waitlist-key';
				nameRow.appendChild(waitlist);

				// Registration date
				const regSpan = textEl('span', fmtDate(c.registration_timestamp), 'climber-meta');
				nameRow.appendChild(regSpan);

				// Presence badge
				if(c.present){
					const pres = createEl('span', 'presence-badge present');
					pres.title = 'Present';
					pres.textContent = 'âœ”';
					nameRow.appendChild(pres);
				}

				// Meta: sex, club, category, routes bars
				metaRow.appendChild(textEl('span', c.sex || ''));
				const clubEl = createEl('span');
				const ital = document.createElement('i'); ital.textContent = c.club || ''; clubEl.appendChild(ital);
				metaRow.appendChild(clubEl);

				const catKey = getCatKey(comp.competition_type, c.category);
				const catSpan = createEl('span');
				catSpan.setAttribute('data-translate-key', catKey);
				catSpan.textContent = typeof getTranslation === 'function' ? (getTranslation(catKey) || '') : '';
				metaRow.appendChild(catSpan);

				const routeCount = Array.isArray(c.routesClimbed) ? c.routesClimbed.length : 0;
				const maxbars = 50;
				const show = routeCount > maxbars ? maxbars : routeCount;
				const editLink = document.createElement('a');
				editLink.href = `/competitionRoutesEntry/${competitionId}/climber/${climberId}`;
				editLink.setAttribute('alt', 'Click to edit');
				const bars = createEl('div', 'routes-bars');
				bars.setAttribute('aria-label', `${routeCount} routes`);
				bars.title = `${routeCount} routes climbed`;
				for(let i=0;i<show;i++){
					const bar = createEl('span', 'routes-bar');
					const h = routeCount>0 ? Math.floor(6 + ( (i / (show||1)) * 8 )) : 0;
					bar.style.height = `${h}px`;
					bars.appendChild(bar);
				}
				const countSpan = textEl('span', String(routeCount));
				bars.appendChild(countSpan);
				editLink.appendChild(bars);
				metaRow.appendChild(editLink);

				row.appendChild(nameRow);
				row.appendChild(metaRow);
				container.appendChild(row);
			});
		})
		.catch(err => { console.error('Failed to load competition', err); });
})();
</script>







				{%endif %}



			</div>
		</div>
		<!-- fh5co-blog-section -->

	</div>
		</div>

{% endblock %}