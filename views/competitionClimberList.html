


{% extends "skala3ma-layout.html" %}

{% block topcontent %}


{% endblock %}


	{% block secondarycontent %}

		{% include "competition-menu.html" %}

		<script>
			// Default to empty strings when Jinja variables are undefined
			alertMessage = {{ alert_message | default('') | tojson }};
			infoMessage = {{ info_message  | default('') | tojson }};

            console.log("Alert message: ", alertMessage);

            if (alertMessage != '') {
                showAlert(alertMessage, 'danger')
            }
            if (infoMessage != '') {
                showAlert(infoMessage, 'info')
            }
        </script>
        <!-- competitionClimberList.html -->
		<!--div id="fh5co-blog-section" class="fh5co-section-gray"	-->
					<div class="container">
                        <div class="text-center heading-section">


						<br>
						<h3>{{ reference_data['current_language'].competition_climber_list }} <br>
								{{competition['name'] }} - {{ competition['date']| strftime(format='short')}}</h3>


						<font color="red">	{{ reference_data['current_language'][error_code] }} </font>
                        <font color="red">	{{ reference_data['current_language'][error_code] }} </font>

					    </div>
                    </div>









<!--onclick="location.href='/competitionRoutesEntry/{{ competitionId }}/climber/{{ climberId}}'"-->
<style>
/* Minimal responsive layout for climbers list */
#climberList { display:flex; flex-direction:column; gap:.5rem; }
.climber-row { display:flex; flex-direction:column; padding:.5rem .75rem; border:1px solid #ddd; border-radius:4px; background:#fff; }
@media (min-width:600px){ .climber-row { flex-direction:row; align-items:center; } }
.climber-name { font-size:1.2rem; font-weight:500; display:flex; align-items:center; gap:.5rem; }
.presence-badge { display:inline-block; width:1.35rem; height:1.25rem; line-height:1.25rem; text-align:center; border-radius:50%; font-size:.85rem; font-weight:600; }
.presence-badge.present { background:#198754; color:#fff; }
.presence-badge.absent { background:#6c757d; color:#fff; }
.climber-meta { display:flex; flex-wrap:wrap; gap:.75rem; font-size:.9rem; margin-top:.25rem; }
@media (min-width:600px){ .climber-meta { margin-top:0; margin-left:1rem; } }
/* registration status badge */
.reg-status { padding:0 .6rem; border-radius:12px; font-size:.6rem; font-weight:600; letter-spacing:.5px; text-transform:uppercase; }
.reg-status.registered { background:#198754; color:#fff; }
.reg-status.waitlist { background:#ffc107; color:#000; }
.reg-status.hide { display:none; }
/* thin bars indicator for routes (no goal background) */
.routes-bars { display:flex; align-items:flex-end; gap:2px; height:16px; margin-top:2px; }
.routes-bar { width:3px; background:#198754; border-radius:2px 2px 0 0; animation:grow .4s ease-out; }
@keyframes grow { from { transform:scaleY(0); } to { transform:scaleY(1); } }
</style>
<div id="climberTable"></div>
<script>
(function(){
	if (typeof apiFetchJson !== 'function' && typeof apiFetch !== 'function') { console.error('apiFetch/apiFetchJson global helper missing'); return; }
	if (typeof Tabulator === 'undefined') { console.error('Tabulator not available'); return; }

	const tableEl = document.getElementById('climberTable');
	if(!tableEl) return;

	// Determine competition ID from URL or Jinja fallback
	const path = window.location.pathname;
	let match = path.match(/competitionClimberList\/([^\/]+)/);
	if(!match){ match = path.match(/competition\/([^\/]+)/); }
	const competitionIdFromJinja = {{ competition['id'] | default('') | tojson }};
	const competitionId = (match && match[1]) ? match[1] : (competitionIdFromJinja || '');
	if(!competitionId){ console.error('Cannot determine competitionId'); return; }

	function getCatKey(compType, category){ const prefix = (compType === 0) ? 'adult' : 'youth'; return `competition_category_${prefix}_${category}`; }
	function fmtDate(val){
		if(val == null) return '';
		try{
			const d = (typeof val === 'number') ? new Date(val*1000) : new Date(val);
			if(isNaN(d.getTime())) return '';
			return d.toLocaleDateString();
		} catch(e){ return ''; }
	}

	const fetchComp = (typeof apiFetchJson === 'function')
		? apiFetchJson(`/api1/competition/${competitionId}`)
		: apiFetch(`/api1/competition/${competitionId}`).then(r => { if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); });

	fetchComp
		.then(comp => {
			const rows = [];
			if(comp && comp.climbers){
				for(const [climberId, c] of Object.entries(comp.climbers)){
					const routeCount = Array.isArray(c.routesClimbed) ? c.routesClimbed.length : 0;
					const rs = (c.registration_status || '').toLowerCase();
					const catKey = getCatKey(comp.competition_type, c.category);
					const catLabel = (typeof getTranslation === 'function') ? (getTranslation(catKey) || '') : '';
					rows.push({
						id: climberId,
						name: c.name || '',
						sex: c.sex || '',
						club: c.club || '',
						category: catLabel,
						routes: routeCount,
						registeredOn: fmtDate(c.registration_timestamp),
						present: !!c.present,
						status: rs.includes('wait') ? 'Waitlist' : (rs.includes('register') ? 'Registered' : '')
					});
				}
			}

			const table = new Tabulator(tableEl, {
				data: rows,
				layout: "fitDataStretch",
				responsiveLayout: "collapse",
				responsiveLayoutCollapseStartOpen: true,
				initialSort: [
					{column: "name", dir: "asc"}
				],
				columns: [
					{title: (typeof getTranslation === 'function' ? (getTranslation('Name') || 'Name') : 'Name'), field: "name", responsive: 0, headerSort: true,
						formatter: function(cell){
							const d = cell.getRow().getData();
							const url = `/competitionRoutesEntry/${competitionId}/climber/${d.id}`;
							const val = cell.getValue() || '';
							return `<a href="${url}"><b>${val}</b></a>`;
						}
					},
					{title: (typeof getTranslation === 'function' ? (getTranslation('Registered') || 'Registered') : 'Registered'), field: "status", responsive: 1,
						formatter: function(cell){
							const v = (cell.getValue() || '').toLowerCase();
							if(v === 'registered') return '<span class="reg-status registered show" data-translate-key="registered">Registered</span>';
							if(v === 'waitlist') return '<span class="reg-status waitlist show" data-translate-key="waitlist">Waitlist</span>';
							return '';
						}
					},
					{title: (typeof getTranslation === 'function' ? (getTranslation('Present') || 'Present') : 'Present'), field: "present", responsive: 2, hozAlign: "center", formatter: "tickCross", width: 100},
					{title: (typeof getTranslation === 'function' ? (getTranslation('Registered Date') || 'Registered Date') : 'Registered Date'), field: "registeredOn", responsive: 3},
					{title: (typeof getTranslation === 'function' ? (getTranslation('Club') || 'Club') : 'Club'), field: "club", responsive: 4},
					{title: (typeof getTranslation === 'function' ? (getTranslation('Category') || 'Category') : 'Category'), field: "category", responsive: 5},
					{title: (typeof getTranslation === 'function' ? (getTranslation('Sex') || 'Sex') : 'Sex'), field: "sex", responsive: 6},
					{title: (typeof getTranslation === 'function' ? (getTranslation('Routes') || 'Routes') : 'Routes'), field: "routes", responsive: 7, hozAlign: "right"},
				],
				rowClick: function(e, row){
					const d = row.getData();
					window.location.href = `/competitionRoutesEntry/${competitionId}/climber/${d.id}`;
				}
			});
		})
		.catch(err => { console.error('Failed to load competition', err); });
})();
</script>









			</div>
		</div>
		<!-- fh5co-blog-section -->

	</div>
		</div>

{% endblock %}